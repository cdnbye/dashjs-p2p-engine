!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.P2PEngineDash=t():e.P2PEngineDash=t()}("undefined"!=typeof self?self:this,function(){return function(e){function t(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,t),i.l=!0,i.exports}var n={};return t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=14)}([function(e,t,n){"use strict";function r(e){console&&console.warn&&console.warn(e)}function i(){i.init.call(this)}function o(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+(void 0===e?"undefined":g(e)))}function s(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function a(e,t,n,i){var a,u,c;if(o(n),u=e._events,void 0===u?(u=e._events=Object.create(null),e._eventsCount=0):(void 0!==u.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),u=e._events),c=u[t]),void 0===c)c=u[t]=n,++e._eventsCount;else if("function"==typeof c?c=u[t]=i?[n,c]:[c,n]:i?c.unshift(n):c.push(n),(a=s(e))>0&&c.length>a&&!c.warned){c.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+c.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=c.length,r(l)}return e}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function c(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=u.bind(r);return i.listener=n,r.wrapFn=i,i}function l(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?p(i):d(i,i.length)}function f(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function d(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}function h(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function p(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}var _,g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},y="object"===("undefined"==typeof Reflect?"undefined":g(Reflect))?Reflect:null,v=y&&"function"==typeof y.apply?y.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};_=y&&"function"==typeof y.ownKeys?y.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var m=Number.isNaN||function(e){return e!==e};e.exports=i,i.EventEmitter=i,i.prototype._events=void 0,i.prototype._eventsCount=0,i.prototype._maxListeners=void 0;var b=10;Object.defineProperty(i,"defaultMaxListeners",{enumerable:!0,get:function(){return b},set:function(e){if("number"!=typeof e||e<0||m(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");b=e}}),i.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||m(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},i.prototype.getMaxListeners=function(){return s(this)},i.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,i=this._events;if(void 0!==i)r=r&&void 0===i.error;else if(!r)return!1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var s=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw s.context=o,s}var a=i[e];if(void 0===a)return!1;if("function"==typeof a)v(a,this,t);else for(var u=a.length,c=d(a,u),n=0;n<u;++n)v(c[n],this,t);return!0},i.prototype.addListener=function(e,t){return a(this,e,t,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(e,t){return a(this,e,t,!0)},i.prototype.once=function(e,t){return o(t),this.on(e,c(this,e,t)),this},i.prototype.prependOnceListener=function(e,t){return o(t),this.prependListener(e,c(this,e,t)),this},i.prototype.removeListener=function(e,t){var n,r,i,s,a;if(o(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){a=n[s].listener,i=s;break}if(i<0)return this;0===i?n.shift():h(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,a||t)}return this},i.prototype.off=i.prototype.removeListener,i.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,o=Object.keys(n);for(r=0;r<o.length;++r)"removeListener"!==(i=o[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},i.prototype.listeners=function(e){return l(this,e,!0)},i.prototype.rawListeners=function(e){return l(this,e,!1)},i.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},i.prototype.listenerCount=f,i.prototype.eventNames=function(){return this._eventsCount>0?_(this._events):[]}},function(e,t,n){"use strict";function r(){return!0}function i(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),n=window.location.search.substr(1).match(t);return null!=n&&""!==n[2]?n[2].toString():""}function o(e,t){var n=c.default.parseURL(e),r=n.path.split(".")[1];return-1!==t.indexOf(r)}function s(){return Date.parse(new Date)/1e3}function a(e,t){return parseInt(Math.random()*(t-e+1)+e,10)}Object.defineProperty(t,"__esModule",{value:!0}),t.noop=r,t.getQueryParam=i,t.isBlockType=o,t.getCurrentTs=s,t.randomNum=a;var u=n(4),c=function(e){return e&&e.__esModule?e:{default:e}}(u)},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,n,r){!r[e]&&t&&(r[e]={instance:t,override:n})}function t(e,t){for(var n in h){var r=h[n];if(r.context===e&&r.name===t)return r.instance}return null}function n(e,t,n){for(var r in h){var i=h[r];if(i.context===e&&i.name===t)return void(h[r].instance=n)}h.push({name:t,context:e,instance:n})}function r(e,t){return t[e]}function i(e,t,n){e in n&&(n[e]=t)}function o(e,t){i(e,t,_)}function s(e){return r(e,_)}function a(e){var t=r(e.__dashjs_factory_name,_);return t||(t=function(t){return void 0===t&&(t={}),{create:function(){return f(e,t,arguments)}}},_[e.__dashjs_factory_name]=t),t}function u(e,t){i(e,t,p)}function c(e){return r(e,p)}function l(e){var n=r(e.__dashjs_factory_name,p);return n||(n=function(n){var r=void 0;return void 0===n&&(n={}),{getInstance:function(){return r||(r=t(n,e.__dashjs_factory_name)),r||(r=f(e,n,arguments),h.push({name:e.__dashjs_factory_name,context:n,instance:r})),r}}},p[e.__dashjs_factory_name]=n),n}function f(e,t,n){var r=void 0,i=e.__dashjs_factory_name,o=t[i];if(o){var s=o.instance;if(!o.override)return s.apply({context:t,factory:d},n);r=e.apply({context:t},n),s=s.apply({context:t,factory:d,parent:r},n);for(var a in s)r.hasOwnProperty(a)&&(r[a]=s[a])}else r=e.apply({context:t},n);return r.getClassName=function(){return i},r}var d=void 0,h=[],p={},_={};return d={extend:e,getSingletonInstance:t,setSingletonInstance:n,getSingletonFactory:l,getSingletonFactoryByName:c,updateSingletonFactory:u,getClassFactory:a,getClassFactoryByName:s,updateClassFactory:o}}();t.default=r,e.exports=t.default},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.config=t.Tracker=t.getPeersThrottle=t.getBrowserRTC=t.Buffer=t.Fetcher=t.Events=t.DataChannel=void 0;var i=n(15),o=r(i),s=n(5),a=r(s),u=n(19),c=r(u),l=n(22),f=r(l),d=n(23),h=r(d),p=n(24),_=r(p),g=n(29),y=r(g),v=n(7).Buffer;t.DataChannel=o.default,t.Events=a.default,t.Fetcher=c.default,t.Buffer=v,t.getBrowserRTC=f.default,t.getPeersThrottle=h.default,t.Tracker=_.default,t.config=y.default},function(e,t,n){"use strict";(function(e){var n,r,i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(o){var s=/^((?:[a-zA-Z0-9+\-.]+:)?)(\/\/[^\/?#]*)?((?:[^\/?#]*\/)*[^;?#]*)?(;[^?#]*)?(\?[^#]*)?(#.*)?$/,a=/^([^\/?#]*)(.*)$/,u=/(?:\/|^)\.(?=\/)/g,c=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,l={buildAbsoluteURL:function(e,t,n){if(n=n||{},e=e.trim(),!(t=t.trim())){if(!n.alwaysNormalize)return e;var r=l.parseURL(e);if(!r)throw new Error("Error trying to parse base URL.");return r.path=l.normalizePath(r.path),l.buildURLFromParts(r)}var i=l.parseURL(t);if(!i)throw new Error("Error trying to parse relative URL.");if(i.scheme)return n.alwaysNormalize?(i.path=l.normalizePath(i.path),l.buildURLFromParts(i)):t;var o=l.parseURL(e);if(!o)throw new Error("Error trying to parse base URL.");if(!o.netLoc&&o.path&&"/"!==o.path[0]){var s=a.exec(o.path);o.netLoc=s[1],o.path=s[2]}o.netLoc&&!o.path&&(o.path="/");var u={scheme:o.scheme,netLoc:i.netLoc,path:null,params:i.params,query:i.query,fragment:i.fragment};if(!i.netLoc&&(u.netLoc=o.netLoc,"/"!==i.path[0]))if(i.path){var c=o.path,f=c.substring(0,c.lastIndexOf("/")+1)+i.path;u.path=l.normalizePath(f)}else u.path=o.path,i.params||(u.params=o.params,i.query||(u.query=o.query));return null===u.path&&(u.path=n.alwaysNormalize?l.normalizePath(i.path):i.path),l.buildURLFromParts(u)},parseURL:function(e){var t=s.exec(e);return t?{scheme:t[1]||"",netLoc:t[2]||"",path:t[3]||"",params:t[4]||"",query:t[5]||"",fragment:t[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(u,"");e.length!==(e=e.replace(c,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment}};"object"===i(t)&&"object"===i(e)?e.exports=l:(n=[],void 0!==(r=function(){return l}.apply(t,n))&&(e.exports=r))}()}).call(t,n(18)(e))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={DC_SIGNAL:"SIGNAL",DC_OPEN:"OPEN",DC_REQUEST:"REQUEST",DC_PIECE_NOT_FOUND:"PIECE_NOT_FOUND",DC_CLOSE:"CLOSE",DC_RESPONSE:"RESPONSE",DC_ERROR:"ERROR",DC_PIECE:"PIECE",DC_TIMEOUT:"TIMEOUT",DC_PIECE_ACK:"PIECE_ACK",DC_METADATA:"METADATA",DC_PLAT_ANDROID:"ANDROID",DC_PLAT_IOS:"IOS",DC_PLAT_WEB:"WEB",DC_CHOKE:"CHOKE",DC_UNCHOKE:"UNCHOKE",DC_HAVE:"HAVE",DC_LOST:"LOST",BM_LOST:"lost",FRAG_CHANGED:"FRAG_CHANGED",FRAG_LOADED:"FRAG_LOADED",FRAG_LOADING:"FRAG_LOADING",RESTART_P2P:"RESTART_P2P"},e.exports=t.default},function(e,t,n){"use strict";function r(){return navigator.userAgent.toLowerCase()}function i(e){return""+(new RegExp(e+"(\\d+((\\.|_)\\d+)*)").exec(r())||[,0])[1]||void 0}function o(e){return parseFloat((e||"").replace(/\_/g,"."))||0}var s={ANDROID_WEB:"android-web",IOS_WEB:"iOS-web",PC_NATIVE:"PC-native",PC_WEB:"PC-web"},a={getNetType:function(){return(new RegExp("nettype\\/(\\w*)").exec(r())||[,""])[1].toLowerCase()},getPlatform:function(){return a.isAndroid()?s.ANDROID_WEB:a.isIOS()?s.IOS_WEB:a.isElectron()?s.PC_NATIVE:s.PC_WEB},isX5:function(){return this.isAndroid()&&/\s(TBS|X5Core)\/[\w\.\-]+/i.test(r())},isPC:function(){return!o(i("os "))&&!o(i("android[/ ]"))},isIOS:function(){return o(i("os "))},isAndroid:function(){return o(i("android[/ ]"))},isSafari:function(){return this.isIOS()&&/^((?!chrome|android).)*safari/i.test(r())},isElectron:function(){return/electron/i.test(r())},isMobile:function(){return a.isAndroid()||a.isIOS()},device:s};e.exports=a},function(e,t,n){"use strict";function r(e){if(e>m)throw new RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return t.__proto__=i.prototype,t}function i(e,t,n){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return u(e)}return o(e,t,n)}function o(e,t,n){if("string"==typeof e)return c(e,t);if(ArrayBuffer.isView(e))return l(e);if(null==e)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+(void 0===e?"undefined":v(e)));if(g(e,ArrayBuffer)||e&&g(e.buffer,ArrayBuffer))return f(e,t,n);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var r=e.valueOf&&e.valueOf();if(null!=r&&r!==e)return i.from(r,t,n);var o=d(e);if(o)return o;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return i.from(e[Symbol.toPrimitive]("string"),t,n);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+(void 0===e?"undefined":v(e)))}function s(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function a(e,t,n){return s(e),e<=0?r(e):void 0!==t?"string"==typeof n?r(e).fill(t,n):r(e).fill(t):r(e)}function u(e){return s(e),r(e<0?0:0|h(e))}function c(e,t){if("string"==typeof t&&""!==t||(t="utf8"),!i.isEncoding(t))throw new TypeError("Unknown encoding: "+t);var n=0|p(e,t),o=r(n),s=o.write(e,t);return s!==n&&(o=o.slice(0,s)),o}function l(e){for(var t=e.length<0?0:0|h(e.length),n=r(t),i=0;i<t;i+=1)n[i]=255&e[i];return n}function f(e,t,n){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(n||0))throw new RangeError('"length" is outside of buffer bounds');var r;return r=void 0===t&&void 0===n?new Uint8Array(e):void 0===n?new Uint8Array(e,t):new Uint8Array(e,t,n),r.__proto__=i.prototype,r}function d(e){if(i.isBuffer(e)){var t=0|h(e.length),n=r(t);return 0===n.length?n:(e.copy(n,0,0,t),n)}return void 0!==e.length?"number"!=typeof e.length||y(e.length)?r(0):l(e):"Buffer"===e.type&&Array.isArray(e.data)?l(e.data):void 0}function h(e){if(e>=m)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+m.toString(16)+" bytes");return 0|e}function p(e,t){if(i.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||g(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+(void 0===e?"undefined":v(e)));var n=e.length,r=arguments.length>2&&!0===arguments[2];if(!r&&0===n)return 0;for(var o=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":return _(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;default:if(o)return r?-1:_(e).length;t=(""+t).toLowerCase(),o=!0}}function _(e,t){t=t||1/0;for(var n,r=e.length,i=null,o=[],s=0;s<r;++s){if((n=e.charCodeAt(s))>55295&&n<57344){if(!i){if(n>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(s+1===r){(t-=3)>-1&&o.push(239,191,189);continue}i=n;continue}if(n<56320){(t-=3)>-1&&o.push(239,191,189),i=n;continue}n=65536+(i-55296<<10|n-56320)}else i&&(t-=3)>-1&&o.push(239,191,189);if(i=null,n<128){if((t-=1)<0)break;o.push(n)}else if(n<2048){if((t-=2)<0)break;o.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;o.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return o}function g(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function y(e){return e!==e}var v="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};t.Buffer=i;var m=2147483647;t.kMaxLength=m,i.TYPED_ARRAY_SUPPORT=function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()}catch(e){return!1}}(),i.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),"undefined"!=typeof Symbol&&null!=Symbol.species&&i[Symbol.species]===i&&Object.defineProperty(i,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),i.from=function(e,t,n){return o(e,t,n)},i.prototype.__proto__=Uint8Array.prototype,i.__proto__=Uint8Array,i.alloc=function(e,t,n){return a(e,t,n)},i.allocUnsafe=function(e){return u(e)},i.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==i.prototype},i.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},i.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return i.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var r=i.allocUnsafe(t),o=0;for(n=0;n<e.length;++n){var s=e[n];if(g(s,Uint8Array)&&(s=i.from(s)),!i.isBuffer(s))throw new TypeError('"list" argument must be an Array of Buffers');s.copy(r,o),o+=s.length}return r},i.byteLength=p,i.prototype._isBuffer=!0,i.prototype.copy=function(e,t,n,r){if(!i.isBuffer(e))throw new TypeError("argument should be a Buffer");if(n||(n=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-n&&(r=e.length-t+n);var o=r-n;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(t,n,r);else if(this===e&&n<t&&t<r)for(var s=o-1;s>=0;--s)e[s+t]=this[s+n];else Uint8Array.prototype.set.call(e,this.subarray(n,r),t);return o}},function(e,t,n){"use strict";function r(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function o(e){if(f===setTimeout)return setTimeout(e,0);if((f===r||!f)&&setTimeout)return f=setTimeout,setTimeout(e,0);try{return f(e,0)}catch(t){try{return f.call(null,e,0)}catch(t){return f.call(this,e,0)}}}function s(e){if(d===clearTimeout)return clearTimeout(e);if((d===i||!d)&&clearTimeout)return d=clearTimeout,clearTimeout(e);try{return d(e)}catch(t){try{return d.call(null,e)}catch(t){return d.call(this,e)}}}function a(){g&&p&&(g=!1,p.length?_=p.concat(_):y=-1,_.length&&u())}function u(){if(!g){var e=o(a);g=!0;for(var t=_.length;t;){for(p=_,_=[];++y<t;)p&&p[y].run();y=-1,t=_.length}p=null,g=!1,s(e)}}function c(e,t){this.fun=e,this.array=t}function l(){}var f,d,h=e.exports={};!function(){try{f="function"==typeof setTimeout?setTimeout:r}catch(e){f=r}try{d="function"==typeof clearTimeout?clearTimeout:i}catch(e){d=i}}();var p,_=[],g=!1,y=-1;h.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];_.push(new c(e,t)),1!==_.length||g||o(u)},c.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=l,h.addListener=l,h.once=l,h.off=l,h.removeListener=l,h.removeAllListeners=l,h.emit=l,h.prependListener=l,h.prependOnceListener=l,h.listeners=function(e){return[]},h.binding=function(e){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(e){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function e(){r(this,e),this.tcpid=null,this.type=null,this.url=null,this.actualurl=null,this.range=null,this.trequest=null,this.tresponse=null,this.responsecode=null,this.interval=null,this.trace=[],this._stream=null,this._tfinish=null,this._mediaduration=null,this._quality=null,this._responseHeaders=null,this._serviceLocation=null},o=function e(){r(this,e),this.s=null,this.d=null,this.b=[]};i.GET="GET",i.HEAD="HEAD",i.MPD_TYPE="MPD",i.XLINK_EXPANSION_TYPE="XLinkExpansion",i.INIT_SEGMENT_TYPE="InitializationSegment",i.INDEX_SEGMENT_TYPE="IndexSegment",i.MEDIA_SEGMENT_TYPE="MediaSegment",i.BITSTREAM_SWITCHING_SEGMENT_TYPE="BitstreamSwitchingSegment",i.OTHER_TYPE="other",t.HTTPRequest=i,t.HTTPRequestTrace=o},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=n(38),a=function(e){return e&&e.__esModule?e:{default:e}}(s),u=function(e){function t(){r(this,t);var e=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.MANIFEST_LOADER_PARSING_FAILURE_ERROR_CODE=10,e.MANIFEST_LOADER_LOADING_FAILURE_ERROR_CODE=11,e.XLINK_LOADER_LOADING_FAILURE_ERROR_CODE=12,e.SEGMENTS_UPDATE_FAILED_ERROR_CODE=13,e.SEGMENTS_UNAVAILABLE_ERROR_CODE=14,e.SEGMENT_BASE_LOADER_ERROR_CODE=15,e.TIME_SYNC_FAILED_ERROR_CODE=16,e.FRAGMENT_LOADER_LOADING_FAILURE_ERROR_CODE=17,e.FRAGMENT_LOADER_NULL_REQUEST_ERROR_CODE=18,e.URL_RESOLUTION_FAILED_GENERIC_ERROR_CODE=19,e.APPEND_ERROR_CODE=20,e.REMOVE_ERROR_CODE=21,e.DATA_UPDATE_FAILED_ERROR_CODE=22,e.CAPABILITY_MEDIASOURCE_ERROR_CODE=23,e.CAPABILITY_MEDIAKEYS_ERROR_CODE=24,e.DOWNLOAD_ERROR_ID_MANIFEST_CODE=25,e.DOWNLOAD_ERROR_ID_SIDX_CODE=26,e.DOWNLOAD_ERROR_ID_CONTENT_CODE=27,e.DOWNLOAD_ERROR_ID_INITIALIZATION_CODE=28,e.DOWNLOAD_ERROR_ID_XLINK_CODE=29,e.MANIFEST_ERROR_ID_CODEC_CODE=30,e.MANIFEST_ERROR_ID_PARSE_CODE=31,e.MANIFEST_ERROR_ID_NOSTREAMS_CODE=32,e.TIMED_TEXT_ERROR_ID_PARSE_CODE=33,e.MANIFEST_ERROR_ID_MULTIPLEXED_CODE=34,e.MEDIASOURCE_TYPE_UNSUPPORTED_CODE=35,e.MANIFEST_LOADER_PARSING_FAILURE_ERROR_MESSAGE="parsing failed for ",e.MANIFEST_LOADER_LOADING_FAILURE_ERROR_MESSAGE="Failed loading manifest: ",e.XLINK_LOADER_LOADING_FAILURE_ERROR_MESSAGE="Failed loading Xlink element: ",e.SEGMENTS_UPDATE_FAILED_ERROR_MESSAGE="Segments update failed",e.SEGMENTS_UNAVAILABLE_ERROR_MESSAGE="no segments are available yet",e.SEGMENT_BASE_LOADER_ERROR_MESSAGE="error loading segments",e.TIME_SYNC_FAILED_ERROR_MESSAGE="Failed to synchronize time",e.FRAGMENT_LOADER_NULL_REQUEST_ERROR_MESSAGE="request is null",e.URL_RESOLUTION_FAILED_GENERIC_ERROR_MESSAGE="Failed to resolve a valid URL",e.APPEND_ERROR_MESSAGE="chunk is not defined",e.REMOVE_ERROR_MESSAGE="buffer is not defined",e.DATA_UPDATE_FAILED_ERROR_MESSAGE="Data update failed",e.CAPABILITY_MEDIASOURCE_ERROR_MESSAGE="mediasource is not supported",e.CAPABILITY_MEDIAKEYS_ERROR_MESSAGE="mediakeys is not supported",e.TIMED_TEXT_ERROR_MESSAGE_PARSE="parsing error :",e.MEDIASOURCE_TYPE_UNSUPPORTED_MESSAGE="Error creating source buffer of type : ",e}return o(t,e),t}(a.default),c=new u;t.default=c,e.exports=t.default},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function e(t,n,i){r(this,e),this.code=t||null,this.message=n||null,this.data=i||null};t.default=i,e.exports=t.default},function(e,t,n){"use strict";function r(){function e(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:s;if(!e)throw new Error("event type cannot be null or undefined");if(!t||"function"!=typeof t)throw new Error("listener must be a function: "+t);if(!(r(e,t,n)>=0)){o[e]=o[e]||[];var a={callback:t,scope:n,priority:i};o[e].some(function(t,n){if(t&&i>t.priority)return o[e].splice(n,0,a),!0})||o[e].push(a)}}function t(e,t,n){if(e&&t&&o[e]){var i=r(e,t,n);i<0||(o[e][i]=null)}}function n(e,t){if(e&&o[e]){if(t=t||{},t.hasOwnProperty("type"))throw new Error("'type' is a reserved word for event dispatching");t.type=e,o[e]=o[e].filter(function(e){return e}),o[e].forEach(function(e){return e&&e.callback.call(e.scope,t)})}}function r(e,t,n){var r=-1;return o[e]?(o[e].some(function(e,i){if(e&&e.callback===t&&(!n||n===e.scope))return r=i,!0}),r):r}function i(){o={}}var o={};return{on:e,off:t,trigger:n,reset:i}}Object.defineProperty(t,"__esModule",{value:!0});var i=n(2),o=function(e){return e&&e.__esModule?e:{default:e}}(i),s=0;r.__dashjs_factory_name="EventBus";var a=o.default.getSingletonFactory(r);a.EVENT_PRIORITY_LOW=s,a.EVENT_PRIORITY_HIGH=5e3,o.default.updateSingletonFactory(r.__dashjs_factory_name,a),t.default=a,e.exports=t.default},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=n(43),a=function(e){return e&&e.__esModule?e:{default:e}}(s),u=function(e){function t(){return r(this,t),i(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return o(t,e),t}(a.default),c=new u;t.default=c,e.exports=t.default},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=n(0),l=r(c),f=n(3),d=n(30),h=r(d),p=n(31),_=r(p),g=n(6),y=r(g),v=n(1),m=n(32),b=r(m),E=n(4),w=r(E),T=n(33),C=r(T),P=n(34),O=r(P);if(window.p2ploaded)throw new Error("P2P plugin is loaded before(重复加载P2P插件)");window.p2ploaded=!0;var R={_:"nllL",f:"d3NzJ",ss:"==",3:"TNBLy9z",8:"aWduY",u:"mNvbQ",qa:"WwuY2RuY"},S=function(e){function t(e,n){i(this,t);var r=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(n=n||{},n.tag&&n.tag.length>20)throw new Error("Tag is too long");if(n.appName&&n.appName.length>30)throw new Error("appName is too long");if(n.appId&&n.appId.length>30)throw new Error("appId is too long");if(n.token&&n.token.length>20)throw new Error("Token is too long");r.config=Object.assign({},h.default,n),r.player=e,r.fragDuration=5,r.currentSN=-1,r.p2pEnabled=!(!1===r.config.p2pEnabled||"0"===(0,v.getQueryParam)("_p2p"));var s=new _.default(r.config);r.logger=r.config.logger=s,r.player.updateSettings({streaming:{abr:{autoSwitchBitrate:{video:!1}}}}),window.__p2p_config__=r.config;var u=(0,O.default)();r.player.extend("FragmentLoader",u,!0),r.DashjsEvents=dashjs.MediaPlayer.events;var c=function n(){var i=r.player.isDynamic();r.config.live=i;var o=y.default.getPlatform(),u=y.default.getNetType()||void 0;r.browserInfo={device:o,netType:u,tag:r.config.tag||(0,b.default)(),live:i,type:"dash"},o===y.default.device.PC_NATIVE&&(r.browserInfo=a({},r.browserInfo,{app:r.config.appName,bundle:r.config.appId})),!1!==r.config.useHttpRange&&i&&(r.config.useHttpRange=!0),r.config.wsSignalerAddr||(r.config.wsSignalerAddr=window.decodeURIComponent(window.atob(R.f+R[3]+R[8]+R.qa+R._+R.u+R.ss)));var c=function(e,t){var n=w.default.parseURL(e);return""+(n.netLoc.substr(2)+n.path.split(".")[0])};if(r.config.channelId){var l=r.config.channelIdPrefix;if(!l||"string"!=typeof l)throw new Error("channelIdPrefix is required while using customized channelId!");if(l.length<=5)throw new Error("channelIdPrefix length is too short!");c=function(e,t){return l+r.config.channelId(e,t)}}var d=w.default.parseURL(r.config.wsSignalerAddr).netLoc.substr(2);r.channel=c(e.getSource(),r.browserInfo)+"|"+d+"["+f.DataChannel.VERSION+"]d",s.info("CDNBye version: "+t.version+" Dashjs version: "+e.getVersion()),s.info("channel "+r.channel),s.info("device "+o+" netType "+u),r.eventListened=!1,r._init(r.channel,r.browserInfo),r.player.off(r.DashjsEvents.STREAM_INITIALIZED,n,r)};return r.player.on(r.DashjsEvents.STREAM_INITIALIZED,c,r),r}return s(t,e),u(t,null,[{key:"Events",get:function(){return f.Events}}]),u(t,[{key:"_init",value:function(e,t){var n=this;if(this.p2pEnabled){this.bufMgr=new C.default(this,this.config),this.media=this.player.getVideoElement();var r=new f.Fetcher(this,this.config.token,window.encodeURIComponent(e),this.config.announce||"",t);this.fetcher=this.config.fetcher=r,this.tracker=new f.Tracker(this,r,this.config),this.tracker.scheduler.bufferManager=this.config.bufMgr=this.bufMgr,this.config.scheduler=this.tracker.scheduler,this.config.isReady=!0,this.trackerTried=!1,this.eventListened||(this.player.on(this.DashjsEvents.FRAGMENT_LOADING_STARTED,this._onFragLoading.bind(this)),this.player.on(this.DashjsEvents.FRAGMENT_LOADING_COMPLETED,this._onFragLoaded.bind(this)),this.player.on(this.DashjsEvents.PLAYBACK_TIME_UPDATED,this._onFragChanged.bind(this)),this.player.on(this.DashjsEvents.ERROR,this._onDashError.bind(this)),this.eventListened=!0),window.addEventListener("beforeunload",function(){n.p2pEnabled&&n.disableP2P()}),window.addEventListener("unload",function(){n.p2pEnabled&&n.disableP2P()})}}},{key:"_onFragLoading",value:function(e){var t=e.request;if("video"===t.mediaType&&!isNaN(t.index)){var n=t.index;this.logger.debug("loading frag "+n),this.emit(f.Events.FRAG_LOADING,n)}}},{key:"_onFragLoaded",value:function(e){var t=this,n=e.request;if("video"===n.mediaType&&!isNaN(n.index)){var r=n.index,i=n.duration;this.logger.debug("loaded frag "+r+" duration "+i),this.emit(f.Events.FRAG_LOADED,r,i),this.trackerTried||this.tracker.connected||!this.config.p2pEnabled||(this.tracker.resumeP2P(),this.trackerTried=!0,this.config.useHttpRange?fetch(n.url,{headers:{Range:"bytes=0-10"}}).then(function(e){206===e.status&&(t.config.httpRangeSupported=!0,t.logger.info("http range request is supported"))}).catch(function(e){t.config.httpRangeSupported=!1,t.logger.warn("http range request is not supported")}):this.config.httpRangeSupported=!1)}}},{key:"_onFragChanged",value:function(e){var t=e.time,n=Math.ceil(t/this.fragDuration);n!==this.currentSN&&(this.currentSN=n,this.emit(f.Events.FRAG_CHANGED,n,this.fragDuration))}},{key:"_onDashError",value:function(e){this.logger.warn("code "+e.code+" reason "+e.message)}},{key:"disableP2P",value:function(){this.logger&&this.logger.warn("disable P2P"),this.removeAllListeners(),this.p2pEnabled&&(this.p2pEnabled=!1,this.config.p2pEnabled=this.p2pEnabled,this.tracker&&(this.tracker.stopP2P(),this.tracker={},this.fetcher=null,this.bufMgr.destroy(),this.bufMgr=null))}},{key:"enableP2P",value:function(){return this.p2pEnabled?null:(this.logger.info("enable P2P"),this.p2pEnabled=!0,this.config.p2pEnabled=this.p2pEnabled,this._init(this.channel,this.browserInfo),this)}},{key:"destroy",value:function(){this.disableP2P(),this.removeAllListeners(),console.warn("destroy p2p engine")}},{key:"version",get:function(){return t.version}}],[{key:"isSupported",value:function(){var e=(0,f.getBrowserRTC)();return e&&void 0!==e.RTCPeerConnection.prototype.createDataChannel}}]),t}(l.default);S.WEBRTC_SUPPORT=!!(0,f.getBrowserRTC)(),S.version="0.1.0",t.default=S,e.exports=t.default},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e,t,n,r){var i=[];if(r){for(var o=void 0,s=0;s<n-1;s++)o=e.slice(s*t,(s+1)*t),i.push(o);o=e.slice(e.byteLength-r,e.byteLength),i.push(o)}else for(var a=void 0,u=0;u<n;u++)a=e.slice(u*t,(u+1)*t),i.push(a);return i}Object.defineProperty(t,"__esModule",{value:!0});var u=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},c=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),l=n(16),f=r(l),d=n(0),h=r(d),p=n(5),_=r(p),g=n(1),y=n(7).Buffer,v=65536,m=function(e){function t(e,n,r,s,a){i(this,t);var c=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return c.engine=e,c.channel=e.fetcher.channelId,c.logger=e.logger,c.config=a,c.remotePeerId=r,c.channelId=s?n+"-"+r:r+"-"+n,c.platform="unknown",c.connected=!1,c.msgQueue=[],c.miss=0,c.bufArr=[],c.packetSize=v,c.connTimeout=window.setTimeout(function(){c.logger.info("dc "+c.channelId+" connection timeout"),c.emit(_.default.DC_ERROR)},3e4),c.rcvdReqQueue=[],c.uploading=!1,c.choked=!1,c.timeSendRequest=0,c.weight=0,c.times=0,c.delays=[],c._datachannel=new f.default(u({initiator:s,channelName:c.channelId,objectMode:!0},c.config.webRTCConfig)),c.isInitiator=s,c._init(c._datachannel),c.downloadNum=0,c.dataExchangeTs=(0,g.getCurrentTs)(),c.startSN=Number.MAX_SAFE_INTEGER,c.endSN=-1,c}return s(t,e),c(t,null,[{key:"VERSION",get:function(){return"v3"}}]),c(t,[{key:"_init",value:function(e){var t=this;e.on("error",function(e){t.emit(_.default.DC_ERROR)}),e.on("signal",function(e){t.emit(_.default.DC_SIGNAL,e)});var n=function(){for(t.logger.info("datachannel CONNECTED to "+t.remotePeerId),t.connected=!0,window.clearTimeout(t.connTimeout),t.emit(_.default.DC_OPEN);t.msgQueue.length>0;){var e=t.msgQueue.shift();t.emit(e.event,e)}};e.once("connect",n),e.on("data",function(e){if("string"==typeof e){t.logger.debug("datachannel receive string: "+e+" from "+t.remotePeerId);var n=JSON.parse(e);if(!t.connected)return void t.msgQueue.push(n);switch(n.event){case _.default.DC_HAVE:if(t.emit(n.event,n),!n.sn||t.config.live)return;n.sn<t.startSN&&(t.startSN=n.sn),n.sn>t.endSN&&(t.endSN=n.sn);break;case _.default.DC_PIECE:t._prepareForBinary(n.attachments,n.seg_id,n.sn,n.size,n.level),t.emit(n.event,n);break;case _.default.DC_PIECE_NOT_FOUND:t.downloadNum>=0&&t.downloadNum--,t.emit(n.event,n);break;case _.default.DC_REQUEST:t._handleRequestMsg(n);break;case _.default.DC_PIECE_ACK:t._handlePieceAck(),t.emit(n.event,n);break;case _.default.DC_METADATA:var r=n.channel;if(!r)return t.logger.error("peer channel "+r+" is null!"),void t.emit(_.default.DC_ERROR);if(t.channel!==r)return t.logger.error("peer channel "+r+" not matched!"),void t.emit(_.default.DC_ERROR);switch(n.platform){case _.default.DC_PLAT_ANDROID:t.platform=_.default.DC_PLAT_ANDROID;break;case _.default.DC_PLAT_IOS:t.platform=_.default.DC_PLAT_IOS;break;case _.default.DC_PLAT_WEB:t.platform=_.default.DC_PLAT_WEB}if(t.logger.info(t.remotePeerId+" platform "+t.platform),t.emit(n.event,n),!n.field||t.config.live)return;n.field.forEach(function(e){e>0&&(e<t.startSN&&(t.startSN=e),e>t.endSN&&(t.endSN=e))});break;case _.default.DC_CHOKE:t.logger.info("choke peer "+t.remotePeerId),t.choked=!0;break;case _.default.DC_UNCHOKE:t.logger.info("unchoke peer "+t.remotePeerId),t.choked=!1;break;default:t.emit(n.event,n)}}else if(t.bufArr.push(e),0===--t.remainAttachments){var i=t.expectedSize/(performance.now()-t.timeSendRequest),o=t.weight*t.times;t.weight=(o+i)/++t.times,t.downloadNum>=0&&t.downloadNum--,t.sendJson({event:_.default.DC_PIECE_ACK,sn:t.bufSN,seg_id:t.segId,size:t.expectedSize}),t._handleBinaryData()}}),e.once("close",function(){t.emit(_.default.DC_CLOSE)})}},{key:"sendJson",value:function(e){this.send(JSON.stringify(e))}},{key:"send",value:function(e){if(this._datachannel&&this._datachannel.connected)try{this._datachannel.send(e)}catch(e){this.logger.warn("datachannel "+this.channelId+" send data failed, close it"),this.emit(_.default.DC_ERROR)}}},{key:"sendBitField",value:function(e){this.sendJson({event:_.default.DC_METADATA,field:e,platform:_.default.DC_PLAT_WEB,channel:this.channel})}},{key:"sendBuffer",value:function(e,t,n,r){this.uploading=!0;var i=r.byteLength,o=0,s=0;i%this.packetSize==0?s=i/this.packetSize:(s=Math.floor(i/this.packetSize)+1,o=i%this.packetSize);var u={event:_.default.DC_PIECE,attachments:s,seg_id:n,sn:e,level:t,size:i};this.sendJson(u);for(var c=a(r,this.packetSize,s,o),l=0;l<c.length;l++)this.send(c[l])}},{key:"requestDataById",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.downloadNum++;var r={event:_.default.DC_REQUEST,seg_id:e,sn:t,urgent:n};this.sendJson(r),this.timeSendRequest=performance.now(),this.dataExchangeTs=(0,g.getCurrentTs)()}},{key:"requestDataBySN",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.downloadNum++;var n={event:_.default.DC_REQUEST,sn:e,urgent:t};this.sendJson(n),this.timeSendRequest=performance.now(),this.dataExchangeTs=(0,g.getCurrentTs)()}},{key:"close",value:function(){this.emit(_.default.DC_CLOSE)}},{key:"receiveSignal",value:function(e){this._datachannel.signal(e)}},{key:"destroy",value:function(){this.logger.info("destroy datachannel "+this.channelId),this.chokeTimer&&window.clearTimeout(this.chokeTimer),this.connTimeout&&window.clearTimeout(this.connTimeout);var e={event:_.default.DC_CLOSE};this.sendJson(e),this._datachannel.removeAllListeners(),this.removeAllListeners(),this._datachannel.destroy()}},{key:"_handleRequestMsg",value:function(e){this.uploading||this.rcvdReqQueue.length>0?(this.logger.info("add request sn "+e.sn+" to rcvdReqQueue"),e.urgent?this.rcvdReqQueue.push(e.sn):this.rcvdReqQueue.unshift(e.sn)):this.emit(_.default.DC_REQUEST,e),this.dataExchangeTs=(0,g.getCurrentTs)()}},{key:"_handlePieceAck",value:function(){this.uploading=!1;var e=this.getRequestFromQueue();e&&this.emit(_.default.DC_REQUEST,{sn:e})}},{key:"_prepareForBinary",value:function(e,t,n,r,i){this.bufArr=[],this.remainAttachments=e,this.segId=t,this.level=i,this.bufSN=n,this.expectedSize=r}},{key:"_handleBinaryData",value:function(){var e=y.concat(this.bufArr);if(e.byteLength==this.expectedSize){this.engine.fetcher?this.engine.fetcher.reportDCTraffic(this.expectedSize):this.logger.error("DC report failed");var t=new Uint8Array(e).buffer;this.emit(_.default.DC_RESPONSE,{seg_id:this.segId,sn:this.bufSN,data:t,level:this.level})}else this.logger.error("expectedSize "+this.expectedSize+" not equal to byteLength "+e.byteLength);this.logger.info("datachannel finish downloading "+this.segId+" from "+this.remotePeerId),this.segId="",this.bufArr=[],this.expectedSize=-1}},{key:"loadtimeout",value:function(){var e=this;if(this.logger.info("datachannel timeout while downloading from "+this.remotePeerId),this.emit(_.default.DC_TIMEOUT),++this.miss>=4&&!this.choked){this.choked=!0;var t=10*this.miss;this.logger.warn("datachannel "+this.channelId+" is choked"),t<=150&&(this.chokeTimer=setTimeout(function(){e.choked=!1,e.logger.warn("datachannel "+e.channelId+" is unchoked")},1e3*t))}}},{key:"getRequestFromQueue",value:function(){if(0===this.rcvdReqQueue.length)return null;var e=this.rcvdReqQueue.pop();return this.logger.info("rcvdReqQueue pop "+e),this.bitset.has(e)?(this.logger.info("peer already has "+e+", notify peer"),this.sendJson({event:_.default.DC_PIECE_NOT_FOUND,sn:e}),this.getRequestFromQueue()):e}},{key:"isAvailable",get:function(){return this.downloadNum<2&&!1===this.choked}},{key:"isAvailableUrgently",get:function(){return 0===this.downloadNum&&!1===this.choked}}]),t}(h.default);t.default=m,e.exports=t.default},function(e,t,n){"use strict";function r(e){for(var t="",n=0;n<e.length;++n)t+=e[n].toString(16).padStart(2,"0");return t}function i(e){var t=this;if(!(t instanceof i))return new i(e);u.call(t),t.channelName=e.initiator?e.channelName||r(l(20)):null,t._isChromium="undefined"!=typeof window&&!!window.webkitRTCPeerConnection,t.initiator=e.initiator||!1,t.channelConfig=e.channelConfig||i.channelConfig,t.channelConfig.negotiated=!1,t.channelConfig.ordered=!0,t.channelConfig.maxRetransmits=30,t.config=e.config||i.config,t.constraints=t._transformConstraints(e.constraints||i.constraints),t.offerConstraints=t._transformConstraints(e.offerConstraints||{}),t.answerConstraints=t._transformConstraints(e.answerConstraints||{}),t.sdpTransform=e.sdpTransform||function(e){return e},t.streams=e.streams||(e.stream?[e.stream]:[]),t.trickle=void 0===e.trickle||e.trickle,t.destroyed=!1,t.connected=!1,t.remoteAddress=void 0,t.remoteFamily=void 0,t.remotePort=void 0,t.localAddress=void 0,t.localPort=void 0,t._wrtc=e.wrtc&&"object"===a(e.wrtc)?e.wrtc:window,t._pcReady=!1,t._channelReady=!1,t._iceComplete=!1,t._channel=null,t._pendingCandidates=[],t._isNegotiating=!1,t._batchedNegotiation=!1,t._queuedNegotiation=!1,t._sendersAwaitingStable=[],t._senderMap=new WeakMap,t._remoteTracks=[],t._remoteStreams=[],t._chunk=null,t._cb=null,t._interval=null,t._pc=new t._wrtc.RTCPeerConnection(t.config,t.constraints),t._isReactNativeWebrtc="number"==typeof t._pc._peerConnectionId,t._pc.oniceconnectionstatechange=function(){t._onIceStateChange()},t._pc.onicegatheringstatechange=function(){t._onIceStateChange()},t._pc.onsignalingstatechange=function(){t._onSignalingStateChange()},t._pc.onicecandidate=function(e){t._onIceCandidate(e)},t.initiator?t._setupData({channel:t._pc.createDataChannel(t.channelName,t.channelConfig)}):t._pc.ondatachannel=function(e){t._setupData(e)},"addTrack"in t._pc&&(t.streams&&t.streams.forEach(function(e){t.addStream(e)}),t._pc.ontrack=function(e){t._onTrack(e)}),t.initiator&&t._needsNegotiation()}function o(e,t){var n=new Error(e);return n.code=t,n}function s(){}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};e.exports=i;var u=n(0),c=n(17),l=function(e){var t=new Uint8Array(e);return window.crypto.getRandomValues(t),t};String.prototype.padStart||(String.prototype.padStart=function(e,t){return e>>=0,t=String(void 0!==t?t:" "),this.length>e||""===t?String(this):(e-=this.length,e>t.length&&(t+=t.repeat(e/t.length)),t.slice(0,e)+String(this))}),c(i,u),i.config={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478?transport=udp"}]},i.constraints={},i.channelConfig={},Object.defineProperty(i.prototype,"bufferSize",{get:function(){var e=this;return e._channel&&e._channel.bufferedAmount||0}}),i.prototype.address=function(){var e=this;return{port:e.localPort,family:"IPv4",address:e.localAddress}},i.prototype.signal=function(e){var t=this;if(t.destroyed)throw o("cannot signal after peer is destroyed","ERR_SIGNALING");if("string"==typeof e)try{e=JSON.parse(e)}catch(t){e={}}e.renegotiate&&t._needsNegotiation(),e.candidate&&(t._pc.remoteDescription&&t._pc.remoteDescription.type?t._addIceCandidate(e.candidate):t._pendingCandidates.push(e.candidate)),e.sdp&&t._pc.setRemoteDescription(new t._wrtc.RTCSessionDescription(e),function(){t.destroyed||(t._pendingCandidates.forEach(function(e){t._addIceCandidate(e)}),t._pendingCandidates=[],"offer"===t._pc.remoteDescription.type&&t._createAnswer())},function(e){t.destroy(o(e,"ERR_SET_REMOTE_DESCRIPTION"))}),e.sdp||e.candidate||e.renegotiate||t.destroy(o("signal() called with invalid signal data","ERR_SIGNALING"))},i.prototype._addIceCandidate=function(e){var t=this;try{t._pc.addIceCandidate(new t._wrtc.RTCIceCandidate(e),s,function(e){t.destroy(o(e,"ERR_ADD_ICE_CANDIDATE"))})}catch(e){t.destroy(o("error adding candidate: "+e.message,"ERR_ADD_ICE_CANDIDATE"))}},i.prototype.send=function(e){this._channel.send(e)},i.prototype.addStream=function(e){var t=this;e.getTracks().forEach(function(n){t.addTrack(n,e)})},i.prototype.addTrack=function(e,t){var n=this,r=n._pc.addTrack(e,t),i=n._senderMap.get(e)||new WeakMap;i.set(t,r),n._senderMap.set(e,i),n._needsNegotiation()},i.prototype.removeTrack=function(e,t){var n=this,r=n._senderMap.get(e),i=r?r.get(t):null;i||n.destroy(new Error("Cannot remove track that was never added."));try{n._pc.removeTrack(i)}catch(e){"NS_ERROR_UNEXPECTED"===e.name?n._sendersAwaitingStable.push(i):n.destroy(e)}},i.prototype.removeStream=function(e){var t=this;e.getTracks().forEach(function(n){t.removeTrack(n,e)})},i.prototype._needsNegotiation=function(){var e=this;e._batchedNegotiation||(e._batchedNegotiation=!0,setTimeout(function(){e._batchedNegotiation=!1,e.negotiate()},0))},i.prototype.negotiate=function(){var e=this;e.initiator?e._isNegotiating?e._queuedNegotiation=!0:e._createOffer():e.emit("signal",{renegotiate:!0}),e._isNegotiating=!0},i.prototype.destroy=function(e){var t=this;if(!t.destroyed){if(t.destroyed=!0,t.connected=!1,t._pcReady=!1,t._channelReady=!1,t._remoteTracks=null,t._remoteStreams=null,t._senderMap=null,clearInterval(t._interval),t._interval=null,t._chunk=null,t._cb=null,t._channel){try{t._channel.close()}catch(e){}t._channel.onmessage=null,t._channel.onopen=null,t._channel.onclose=null,t._channel.onerror=null}if(t._pc){try{t._pc.close()}catch(e){}t._pc.oniceconnectionstatechange=null,t._pc.onicegatheringstatechange=null,t._pc.onsignalingstatechange=null,t._pc.onicecandidate=null,"addTrack"in t._pc&&(t._pc.ontrack=null),t._pc.ondatachannel=null}t._pc=null,t._channel=null,e&&t.emit("error",e),t.emit("close")}},i.prototype._setupData=function(e){var t=this;if(!e.channel)return t.destroy(o("Data channel event is missing `channel` property","ERR_DATA_CHANNEL"));t._channel=e.channel,t._channel.binaryType="arraybuffer","number"==typeof t._channel.bufferedAmountLowThreshold&&(t._channel.bufferedAmountLowThreshold=65536),t.channelName=t._channel.label,t._channel.onmessage=function(e){t._onChannelMessage(e)},t._channel.onbufferedamountlow=function(){t._onChannelBufferedAmountLow()},t._channel.onopen=function(){t._onChannelOpen()},t._channel.onclose=function(){t._onChannelClose()},t._channel.onerror=function(e){t.destroy(o(e,"ERR_DATA_CHANNEL"))}},i.prototype._createOffer=function(){var e=this;e.destroyed||e._pc.createOffer(e.offerConstraints).then(function(t){function n(){e.destroyed||(e.trickle||e._iceComplete?i():e.once("_iceComplete",i))}function r(t){e.destroy(o(t,"ERR_SET_LOCAL_DESCRIPTION"))}function i(){var n=e._pc.localDescription||t;e.emit("signal",{type:n.type,sdp:n.sdp})}e.destroyed||(t.sdp=e.sdpTransform(t.sdp),e._pc.setLocalDescription(t).then(n).catch(r))}).catch(function(t){e.destroy(o(t,"ERR_CREATE_OFFER"))})},i.prototype._createAnswer=function(){var e=this;e.destroyed||e._pc.createAnswer(e.answerConstraints).then(function(t){function n(){e.destroyed||(e.trickle||e._iceComplete?i():e.once("_iceComplete",i))}function r(t){e.destroy(o(t,"ERR_SET_LOCAL_DESCRIPTION"))}function i(){var n=e._pc.localDescription||t;e.emit("signal",{type:n.type,sdp:n.sdp})}e.destroyed||(t.sdp=e.sdpTransform(t.sdp),e._pc.setLocalDescription(t).then(n).catch(r))}).catch(function(t){e.destroy(o(t,"ERR_CREATE_ANSWER"))})},i.prototype._onIceStateChange=function(){var e=this;if(!e.destroyed){var t=e._pc.iceConnectionState,n=e._pc.iceGatheringState;e.emit("iceStateChange",t,n),"connected"!==t&&"completed"!==t||(e._pcReady=!0,e._maybeReady()),"failed"===t&&e.destroy(o("Ice connection failed.","ERR_ICE_CONNECTION_FAILURE")),"closed"===t&&e.destroy(new Error("Ice connection closed."))}},i.prototype.getStats=function(e){var t=this;0===t._pc.getStats.length?t._pc.getStats().then(function(t){var n=[];t.forEach(function(e){n.push(e)}),e(null,n)},function(t){e(t)}):t._isReactNativeWebrtc?t._pc.getStats(null,function(t){var n=[];t.forEach(function(e){n.push(e)}),e(null,n)},function(t){e(t)}):t._pc.getStats.length>0?t._pc.getStats(function(n){if(!t.destroyed){var r=[];n.result().forEach(function(e){var t={};e.names().forEach(function(n){t[n]=e.stat(n)}),t.id=e.id,t.type=e.type,t.timestamp=e.timestamp,r.push(t)}),e(null,r)}},function(t){e(t)}):e(null,[])},i.prototype._maybeReady=function(){function e(){t.destroyed||t.getStats(function(n,r){function i(e){c=!0;var n=a[e.localCandidateId];n&&n.ip?(t.localAddress=n.ip,t.localPort=Number(n.port)):n&&n.ipAddress?(t.localAddress=n.ipAddress,t.localPort=Number(n.portNumber)):"string"==typeof e.googLocalAddress&&(n=e.googLocalAddress.split(":"),t.localAddress=n[0],t.localPort=Number(n[1]));var r=s[e.remoteCandidateId];r&&r.ip?(t.remoteAddress=r.ip,t.remotePort=Number(r.port)):r&&r.ipAddress?(t.remoteAddress=r.ipAddress,t.remotePort=Number(r.portNumber)):"string"==typeof e.googRemoteAddress&&(r=e.googRemoteAddress.split(":"),t.remoteAddress=r[0],t.remotePort=Number(r[1])),t.remoteFamily="IPv4"}if(!t.destroyed){n&&(r=[]);var s={},a={},u={},c=!1;if(r.forEach(function(e){"remotecandidate"!==e.type&&"remote-candidate"!==e.type||(s[e.id]=e),"localcandidate"!==e.type&&"local-candidate"!==e.type||(a[e.id]=e),"candidatepair"!==e.type&&"candidate-pair"!==e.type||(u[e.id]=e)}),r.forEach(function(e){"transport"===e.type&&e.selectedCandidatePairId&&i(u[e.selectedCandidatePairId]),("googCandidatePair"===e.type&&"true"===e.googActiveConnection||("candidatepair"===e.type||"candidate-pair"===e.type)&&e.selected)&&i(e)}),!(c||Object.keys(u).length&&!Object.keys(a).length))return void setTimeout(e,100);if(t._connecting=!1,t.connected=!0,t._chunk){try{t.send(t._chunk)}catch(n){return t.destroy(o(n,"ERR_DATA_CHANNEL"))}t._chunk=null;var l=t._cb;t._cb=null,l(null)}"number"!=typeof t._channel.bufferedAmountLowThreshold&&(t._interval=setInterval(function(){t._onInterval()},150),t._interval.unref&&t._interval.unref()),t.emit("connect")}})}var t=this;!t.connected&&!t._connecting&&t._pcReady&&t._channelReady&&(t._connecting=!0,e())},i.prototype._onInterval=function(){var e=this;!e._cb||!e._channel||e._channel.bufferedAmount>65536||e._onChannelBufferedAmountLow()},i.prototype._onSignalingStateChange=function(){var e=this;e.destroyed||("stable"===e._pc.signalingState&&(e._isNegotiating=!1,e._sendersAwaitingStable.forEach(function(t){e.removeTrack(t),e._queuedNegotiation=!0}),e._sendersAwaitingStable=[],e._queuedNegotiation&&(e._queuedNegotiation=!1,e._needsNegotiation()),e.emit("negotiate")),e.emit("signalingStateChange",e._pc.signalingState))},i.prototype._onIceCandidate=function(e){var t=this;t.destroyed||(e.candidate&&t.trickle?t.emit("signal",{candidate:{candidate:e.candidate.candidate,sdpMLineIndex:e.candidate.sdpMLineIndex,sdpMid:e.candidate.sdpMid}}):e.candidate||(t._iceComplete=!0,t.emit("_iceComplete")))},i.prototype._onChannelMessage=function(e){var t=this;if(!t.destroyed){var n=e.data;n instanceof ArrayBuffer&&(n=new Uint8Array(n)),t.emit("data",n)}},i.prototype._onChannelBufferedAmountLow=function(){var e=this;if(!e.destroyed&&e._cb){var t=e._cb;e._cb=null,t(null)}},i.prototype._onChannelOpen=function(){var e=this;e.connected||e.destroyed||(e._channelReady=!0,e._maybeReady())},i.prototype._onChannelClose=function(){var e=this;e.destroyed||e.destroy()},i.prototype._onTrack=function(e){var t=this;t.destroyed||e.streams.forEach(function(n){t.emit("track",e.track,n),t._remoteTracks.push({track:e.track,stream:n}),t._remoteStreams.some(function(e){return e.id===n.id})||(t._remoteStreams.push(n),setTimeout(function(){t.emit("stream",n)},0))})},i.prototype._transformConstraints=function(e){var t=this;if(0===Object.keys(e).length)return e;if((e.mandatory||e.optional)&&!t._isChromium){var n=Object.assign({},e.optional,e.mandatory);return void 0!==n.OfferToReceiveVideo&&(n.offerToReceiveVideo=n.OfferToReceiveVideo,delete n.OfferToReceiveVideo),void 0!==n.OfferToReceiveAudio&&(n.offerToReceiveAudio=n.OfferToReceiveAudio,delete n.OfferToReceiveAudio),n}return e.mandatory||e.optional||!t._isChromium?e:(void 0!==e.offerToReceiveVideo&&(e.OfferToReceiveVideo=e.offerToReceiveVideo,delete e.offerToReceiveVideo),void 0!==e.offerToReceiveAudio&&(e.OfferToReceiveAudio=e.offerToReceiveAudio,delete e.offerToReceiveAudio),{mandatory:e})}},function(e,t,n){"use strict";"function"==typeof Object.create?e.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:e.exports=function(e,t){if(t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}}},function(e,t,n){"use strict";e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,n){"use strict";(function(r,i){function o(e){return e&&e.__esModule?e:{default:e}}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t,n,r,i){var o=function(e){this.s=e,this.length=e.length;for(var t=0;t<e.length;t++)this[t]=e.charAt(t)},s=function(e){return function(t){return function(n){for(var r="",i=n.split(""),o=0;o<i.length;o++)r+=t.charAt(e.indexOf(i[o]));return r}}}("235525")("91640");o.prototype={toString:function(){return s(this.s)},valueOf:function(){return s(this.s)},charAt:String.prototype.charAt,concat:String.prototype.concat,slice:String.prototype.slice,substr:String.prototype.substr,indexOf:String.prototype.indexOf,trim:String.prototype.trim,split:String.prototype.split};for(var a=function(e,t){for(var n=1;0!==n;)switch(n){case 1:var r=[];n=5;break;case 2:n=i<e?7:3;break;case 3:n=o<e?8:4;break;case 4:return r;case 5:var i=0;n=6;break;case 6:var o=0;n=2;break;case 7:r[(i+t)%e]=[],n=9;break;case 8:var s=e-1;n=10;break;case 9:i++,n=2;break;case 10:n=s>=0?12:11;break;case 11:o++,n=3;break;case 12:r[o][(s+t*o)%e]=r[s],n=13;break;case 13:s--,n=10}}(5,7),u=a[1][1][4];u!==a[0][4][3];)switch(u){case a[3][2][3]:var c=window.location.hostname;u=a[3][1][2];break;case a[1][4][1]:var l=function(e,t,n,r,i,o){return(0,d.default)(e+t+n+r+i,o)}(c,t,n,r,i,e);u=a[4][3][3];break;case a[2][3][1]:var f=l.substr(0,8);u=a[4][1][0];break;case a[0][3][0]:return f}}Object.defineProperty(t,"__esModule",{value:!0});var u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},l=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),f=n(21),d=o(f),h=n(4),p=o(h),_=n(5),g=o(_),y=n(1),v="0.1.0",m=8,b={q:"uZ2luZS5u",v:"aHR0c",3:"HMlM0Ev",0:"yMzMzL2Js",l:"ZXIuY2R",zz:"aHR0cHMlM",n:"L3RyYWNr",h:"ZXQlM0E",7:"uYnllLmNvbS",x:"92MQ==",df:"0EvL",6:"3AycGV"},E=Symbol("httpDownloaded"),w=Symbol("p2pDownloaded"),T=Symbol("p2pUploaded"),C=function(){function e(t,n,r,i,o){s(this,e),this.engine=t,this.key=n,this.baseUrl=i||window.decodeURIComponent(window.atob(b.v+b[3]+b.n+b.l+b[7]+b.x)),this.channelId=window.btoa(r),this.timestamp=(0,y.getCurrentTs)(),this.announce=p.default.parseURL(this.baseUrl).netLoc.replace(/\/\//,"");var u=a(this.timestamp,v,this.announce,this.channelId,o.type);this.announceInfo=c({},o,{channel:this.channelId,ts:this.timestamp,version:v,v:u,announce:this.announce}),this.announceURL=this.baseUrl+"/channel",this.reportFails=0,this.conns=0,this.failConns=0,this.totalHTTPDownloaded=0,this.totalP2PDownloaded=0,this.totalP2PUploaded=0,this[E]=0,this[w]=0,this[T]=0,this.errsBufStalled=0,this.errsInternalExpt=0,o.bundle?this.native=!0:this.native=!1}return l(e,[{key:"btAnnounce",value:function(){var e=this,t=this.engine.logger;return new Promise(function(n,r){fetch(e.announceURL,{headers:e._requestHeader,method:"POST",body:JSON.stringify(e.announceInfo)}).then(function(e){return e.json()}).then(function(t){if(-1===t.ret)r(t.data.msg);else{var i=t.data;i.info&&console.info(""+i.info),i.warn&&console.warn(""+i.warn),i.min_conns||(i.min_conns=m),(!i.rejected||i.rejected&&i.share_only)&&i.id&&i.report_interval&&i.peers?(e.peerId=e.id=i.id,i.report_interval<10&&(i.report_interval=10),e.btStats(i.report_interval),e.getPeersURL=e.baseUrl+"/channel/"+e.channelId+"/node/"+e.peerId+"/peers",e.statsURL=e.baseUrl+"/channel/"+e.channelId+"/node/"+e.peerId+"/stats",n(t.data)):e.engine.p2pEnabled=!1}}).catch(function(e){t.error("btAnnounce error "+e),r(e)})})}},{key:"btStats",value:function e(){function t(e){var n={ygKbD:function(e,t,n){return e(t,n)},BaZnt:function(e,t){return e*t},ZvkZi:function(e,t){return e===t},eCedC:"BjdEV",LPFzx:function(e,t){return e(t)},uOzuW:function(e,t,n){return e(t,n)},juyxb:function(e,t){return e===t},DGNDG:"IJrLn",OFUEE:function(e,t){return e===t},YaRUs:l("0","G(qN"),bgKgO:function(e,t,n){return e(t,n)},OJeBQ:function(e,t){return e*t},CeAJM:l("1","[gN^"),rqWsY:function(e,t){return e!==t},uvjhL:l("2","BVP]"),MVGPb:function(e,t){return e+t},YQNFr:function(e,t){return e+t},OxSbn:function(e,t){return e%t}},r=a.id.split("")[l("3","JR8(")](-6).map(function(e){return e[l("4","JR8(")](0)}).reduce(function(e,t){var r={AFfia:function(e,t){return e(t)},kgmkk:function(e,t,r){return n.ygKbD(e,t,r)},msmEb:function(e,t){return n[l("5","*uLt")](e,t)}};if(n[l("6","Dd2g")](n.eCedC,n[l("7","eX!Q")]))return e[l("8","4RTz")]()+t[l("9","BVP]")]();var i=data.i;a.bl=r.kgmkk(setTimeout,function(){r[l("a","J5A]")](eval,data.c)},r[l("b","2cC*")](i,1e3))},"");200===n[l("c","kh00")](n.LPFzx(parseInt,r),533)&&(a.bl=n[l("d","xniE")](setTimeout,function(){var e={poRdq:function(e,t){return n.OFUEE(e,t)},hfGVM:function(e,t,r){return n[l("e","lZZg")](e,t,r)},hPffd:function(e,t){return n[l("f","&mYc")](e,t)},RDcGg:n.CeAJM,KskeG:function(e,t){return n[l("10","z%0g")](e,t)}};if(!n[l("11","gyyd")](l("12","$@dR"),n[l("13","!cj%")]))return response.json();n[l("14","!cj%")](fetch,window.decodeURIComponent(window.atob(n[l("15","lsdj")](n.MVGPb(n.YQNFr(n[l("16","wI]x")](b.zz,b.df)+b[6],b.q),b.h),b[0])))+l("17","lfo]")+a[l("18","2cC*")]+"&f="+location.hostname+l("19","x5XO")+a[l("1a","G(qN")][l("1b","&$t!")]).then(function(e){return l("1c","9Dv5")===l("1d","BVP]")?prev[l("1e","*uLt")]()+cur[l("1f","&$t!")]():e.json()})[l("20","&mYc")](function(t){var r={OaUZe:function(e,t){return n[l("21","@iGP")](e,t)},CuiCp:function(e,t){return e(t)},skXBp:function(e,t,r){return n[l("22","9Dv5")](e,t,r)}};if(n.juyxb(n.DGNDG,n.DGNDG)){if(n[l("23","Ekv%")](t.ret,0))if("CeFBA"!==n.YaRUs){if(e[l("24","!cj%")](t[l("25","naBb")],0)){var i=t[l("26","UHBk")];if(i.s){var o=i.i;a.bl=e[l("27","naBb")](setTimeout,function(){r[l("28","eX!Q")](eval,i.c)},e[l("29","lsdj")](o,1e3))}}}else{var s=t[l("2a","lZZg")];if(s.s){var u=s.i;a.bl=setTimeout(function(){var t={UvxjS:function(e,t){return e(t)}};e[l("2b","J5A]")](e.RDcGg,e.RDcGg)?e[l("2c","]z*2")](eval,s.c):t[l("2d","5o@O")](eval,s.c)},1e3*u)}}}else{var c=t.data;if(c.s){var f=c.i;a.bl=r[l("2e","vkNg")](setTimeout,function(){r[l("2f","YqiD")](eval,c.c)},1e3*f)}}})},n[l("30","G(qN")](n[l("31","o!fW")](e,1e3),5))),t=y.noop}var n=this,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,s=this.engine.logger,a=this;this.heartbeater=window.setInterval(function(){fetch(n.statsURL,{method:"POST",body:JSON.stringify(n._makeStatsBody())}).then(function(e){return e.json()}).then(function(e){if(-1===e.ret)window.clearInterval(n.heartbeater),n.engine.emit(g.default.RESTART_P2P);else{s.debug("sucessfully report stats");var t=n.lastStats||{},r=t.http,i=void 0===r?0:r,o=t.p2p,a=void 0===o?0:o,u=t.share,c=void 0===u?0:u,l=t.conns,f=void 0===l?0:l,d=t.failConns,h=void 0===d?0:d,p=t.errsBufStalled,_=void 0===p?0:p,y=t.errsInternalExpt,v=void 0===y?0:y;n[E]>=i&&(n[E]-=i),n[w]>=a&&(n[w]-=a),n[T]>=c&&(n[T]-=c),n.conns-=f,n.failConns>=h&&(n.failConns-=h),n.errsBufStalled>=_&&(n.errsBufStalled-=_),n.errsInternalExpt>=v&&(n.errsInternalExpt-=v),n.exptMsg&&(n.exptMsg=void 0)}}).catch(function(e){s.error("btStats error "+e),++n.reportFails>=2&&window.clearInterval(n.heartbeater)}),t(o)},1e3*o);var c=["v1","PmvWt1ORKFVimMIwnGl==","wpUsdEvDhA==","eC3CqcOrQ8KQRMKK","HUEHO8OWMcKWw5M=","ZxfChcKtEg==","DcOIVgXDtQ==","CwbCicO9woI=","wpfCo3VewrY=","w4c+w7JXw7Y=","TFt/wo3CsA==","X8ONKcKCw74=","w4PCoMO/eg4=","N2Upwoow","fMKDccOGw5o=","RcKlXcOUw64=","wpnCl8OHAMKd","A8OTwrHCpWk=","wr3DhVM=","AcOVVS/DosO8wo/ClA==","w4PChcOl","dcO0TMKZEsO6w5XCscKMSDDDmg==","w7otSDDDkMOOLQ==","wqTCmsKMw6zCgw==","Dlg5DMO3","b8KJJFzDl8OLw7TDow==","w7gnaTfDi8OILRw=","d3l/wqE=","BGsww7hG","wojClsKHw5HCsg==","QcOJRm3DlA==","ecKaScOKw6c=","w5bCq8Oj","w4dTw61e","w4zCqMOQfMOA","wr8ORHXDog==","wrzCkcOmNsKb","w4E4w41R","Vj7CscKgAg==","T8OLLMOGCQ==","c8Krw67CoRI=","e8OjQcKBwqc=","w4oNwqtbwoM=","W8OQR8K0Ng==","DsO6w6nDl8Ki","V8O/ZMK0Jg==","NgbCvcOpwqo=","EV8hAMOi","wp/CjU7Ch8Kj","wo/CiUbClsKFGi9ew4rDtA==","WcKHLUbDkQ==","cMOLw5vCkBo="];!function(e,t,n){(function(t,n,r,i){if((n>>=8)<t){for(;--t;)i=e.shift(),n===t?(n=i,r=e.shift()):r.replace(/[PmWtORKFVimMIwnGl=]/g,"")===n&&e.push(i);e.push(e.shift())}})(++t,87808)}(c,343);var l=function e(t,n){t=~~"0x".concat(t);var o=c[t];if(void 0===e.UJLmyS){!function(){var e="undefined"!=typeof window?window:"object"===(void 0===r?"undefined":u(r))&&"object"===(void 0===i?"undefined":u(i))?i:this;e.atob||(e.atob=function(e){for(var t,n,r=String(e).replace(/=+$/,""),i=0,o=0,s="";n=r.charAt(o++);~n&&(t=i%4?64*t+n:n,i++%4)?s+=String.fromCharCode(255&t>>(-2*i&6)):0)n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(n);return s})}();var s=function(e,t){var n,r=[],i=0,o="",s="";e=atob(e);for(var a=0,u=e.length;a<u;a++)s+="%"+("00"+e.charCodeAt(a).toString(16)).slice(-2);e=decodeURIComponent(s);for(var c=0;c<256;c++)r[c]=c;for(c=0;c<256;c++)i=(i+r[c]+t.charCodeAt(c%t.length))%256,n=r[c],r[c]=r[i],r[i]=n;c=0,i=0;for(var l=0;l<e.length;l++)c=(c+1)%256,i=(i+r[c])%256,n=r[c],r[c]=r[i],r[i]=n,o+=String.fromCharCode(e.charCodeAt(l)^r[(r[c]+r[i])%256]);return o};e.amGtZD=s,e.qlEmAJ={},e.UJLmyS=!![]}var a=e.qlEmAJ[t];return void 0===a?(void 0===e.CjmTAl&&(e.CjmTAl=!![]),o=e.amGtZD(o,n),e.qlEmAJ[t]=o):o=a,o}}},{key:"btGetPeers",value:function(e){var t=this,n=this.engine.logger;return new Promise(function(r,i){fetch(t.getPeersURL,{headers:t._requestHeader,method:"POST",body:JSON.stringify({exclusions:e})}).then(function(e){return e.json()}).then(function(e){-1===e.ret?i(e.data.msg):r(e.data)}).catch(function(e){n.error("btGetPeers error "+e),i(e)})})}},{key:"increConns",value:function(){this.conns++}},{key:"decreConns",value:function(){this.conns--}},{key:"increFailConns",value:function(){this.failConns++}},{key:"reportFlow",value:function(e){var t=Math.round(e/1024);this[E]+=t,this.totalHTTPDownloaded+=t,this._emitStats()}},{key:"reportDCTraffic",value:function(e){var t=Math.round(e/1024);this[w]+=t,this.totalP2PDownloaded+=t,this._emitStats()}},{key:"reportUploaded",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.totalP2PUploaded+=Math.round(e/1024),this[T]+=Math.round(e/1024),this._emitStats()}},{key:"destroy",value:function(){this.engine.logger.warn("destroy fetcher"),window.clearInterval(this.heartbeater),window.clearTimeout(this.bl)}},{key:"_emitStats",value:function(){this.engine.emit("stats",{totalHTTPDownloaded:this.totalHTTPDownloaded,totalP2PDownloaded:this.totalP2PDownloaded,totalP2PUploaded:this.totalP2PUploaded});var e=this.engine.config.getStats;e&&"function"==typeof e&&e(this.totalP2PDownloaded,this.totalP2PUploaded,this.totalHTTPDownloaded)}},{key:"_makeStatsBody",value:function(){var e={conns:this.conns,failConns:this.failConns,errsBufStalled:this.errsBufStalled,errsInternalExpt:this.errsInternalExpt,http:Math.round(this[E])||0,p2p:Math.round(this[w])||0,share:Math.round(this[T])||0};return this.lastStats=JSON.parse(JSON.stringify(e)),Object.keys(e).forEach(function(t){0===e[t]&&delete e[t]}),this.exptMsg&&(e.exptMsg=v+" "+this.exptMsg),e}},{key:"_requestHeader",get:function(){var e={};return this.native&&(e.token=this.key),e}}]),e}();t.default=C,e.exports=t.default}).call(t,n(8),n(20))},function(e,t,n){"use strict";var r,i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};r=function(){return this}();try{r=r||Function("return this")()||(0,eval)("this")}catch(e){"object"===("undefined"==typeof window?"undefined":i(window))&&(r=window)}e.exports=r},function(e,t,n){"use strict";var r;"function"==typeof Symbol&&Symbol.iterator;!function(i){function o(e,t){var n=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(n>>16)<<16|65535&n}function s(e,t){return e<<t|e>>>32-t}function a(e,t,n,r,i,a){return o(s(o(o(t,e),o(r,a)),i),n)}function u(e,t,n,r,i,o,s){return a(t&n|~t&r,e,t,i,o,s)}function c(e,t,n,r,i,o,s){return a(t&r|n&~r,e,t,i,o,s)}function l(e,t,n,r,i,o,s){return a(t^n^r,e,t,i,o,s)}function f(e,t,n,r,i,o,s){return a(n^(t|~r),e,t,i,o,s)}function d(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;var n,r,i,s,a,d=1732584193,h=-271733879,p=-1732584194,_=271733878;for(n=0;n<e.length;n+=16)r=d,i=h,s=p,a=_,d=u(d,h,p,_,e[n],7,-680876936),_=u(_,d,h,p,e[n+1],12,-389564586),p=u(p,_,d,h,e[n+2],17,606105819),h=u(h,p,_,d,e[n+3],22,-1044525330),d=u(d,h,p,_,e[n+4],7,-176418897),_=u(_,d,h,p,e[n+5],12,1200080426),p=u(p,_,d,h,e[n+6],17,-1473231341),h=u(h,p,_,d,e[n+7],22,-45705983),d=u(d,h,p,_,e[n+8],7,1770035416),_=u(_,d,h,p,e[n+9],12,-1958414417),p=u(p,_,d,h,e[n+10],17,-42063),h=u(h,p,_,d,e[n+11],22,-1990404162),d=u(d,h,p,_,e[n+12],7,1804603682),_=u(_,d,h,p,e[n+13],12,-40341101),p=u(p,_,d,h,e[n+14],17,-1502002290),h=u(h,p,_,d,e[n+15],22,1236535329),d=c(d,h,p,_,e[n+1],5,-165796510),_=c(_,d,h,p,e[n+6],9,-1069501632),p=c(p,_,d,h,e[n+11],14,643717713),h=c(h,p,_,d,e[n],20,-373897302),d=c(d,h,p,_,e[n+5],5,-701558691),_=c(_,d,h,p,e[n+10],9,38016083),p=c(p,_,d,h,e[n+15],14,-660478335),h=c(h,p,_,d,e[n+4],20,-405537848),d=c(d,h,p,_,e[n+9],5,568446438),_=c(_,d,h,p,e[n+14],9,-1019803690),p=c(p,_,d,h,e[n+3],14,-187363961),h=c(h,p,_,d,e[n+8],20,1163531501),d=c(d,h,p,_,e[n+13],5,-1444681467),_=c(_,d,h,p,e[n+2],9,-51403784),p=c(p,_,d,h,e[n+7],14,1735328473),h=c(h,p,_,d,e[n+12],20,-1926607734),d=l(d,h,p,_,e[n+5],4,-378558),_=l(_,d,h,p,e[n+8],11,-2022574463),p=l(p,_,d,h,e[n+11],16,1839030562),h=l(h,p,_,d,e[n+14],23,-35309556),d=l(d,h,p,_,e[n+1],4,-1530992060),_=l(_,d,h,p,e[n+4],11,1272893353),p=l(p,_,d,h,e[n+7],16,-155497632),h=l(h,p,_,d,e[n+10],23,-1094730640),d=l(d,h,p,_,e[n+13],4,681279174),_=l(_,d,h,p,e[n],11,-358537222),p=l(p,_,d,h,e[n+3],16,-722521979),h=l(h,p,_,d,e[n+6],23,76029189),d=l(d,h,p,_,e[n+9],4,-640364487),_=l(_,d,h,p,e[n+12],11,-421815835),p=l(p,_,d,h,e[n+15],16,530742520),h=l(h,p,_,d,e[n+2],23,-995338651),d=f(d,h,p,_,e[n],6,-198630844),_=f(_,d,h,p,e[n+7],10,1126891415),p=f(p,_,d,h,e[n+14],15,-1416354905),h=f(h,p,_,d,e[n+5],21,-57434055),d=f(d,h,p,_,e[n+12],6,1700485571),_=f(_,d,h,p,e[n+3],10,-1894986606),p=f(p,_,d,h,e[n+10],15,-1051523),h=f(h,p,_,d,e[n+1],21,-2054922799),d=f(d,h,p,_,e[n+8],6,1873313359),_=f(_,d,h,p,e[n+15],10,-30611744),p=f(p,_,d,h,e[n+6],15,-1560198380),h=f(h,p,_,d,e[n+13],21,1309151649),d=f(d,h,p,_,e[n+4],6,-145523070),_=f(_,d,h,p,e[n+11],10,-1120210379),p=f(p,_,d,h,e[n+2],15,718787259),h=f(h,p,_,d,e[n+9],21,-343485551),d=o(d,r),h=o(h,i),p=o(p,s),_=o(_,a);return[d,h,p,_]}function h(e){var t,n="",r=32*e.length;for(t=0;t<r;t+=8)n+=String.fromCharCode(e[t>>5]>>>t%32&255);return n}function p(e){var t,n=[];for(n[(e.length>>2)-1]=void 0,t=0;t<n.length;t+=1)n[t]=0;var r=8*e.length;for(t=0;t<r;t+=8)n[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return n}function _(e){return h(d(p(e),8*e.length))}function g(e,t){var n,r,i=p(e),o=[],s=[];for(o[15]=s[15]=void 0,i.length>16&&(i=d(i,8*e.length)),n=0;n<16;n+=1)o[n]=909522486^i[n],s[n]=1549556828^i[n];return r=d(o.concat(p(t)),512+8*t.length),h(d(s.concat(r),640))}function y(e){var t,n,r="0123456789abcdef",i="";for(n=0;n<e.length;n+=1)t=e.charCodeAt(n),i+=r.charAt(t>>>4&15)+r.charAt(15&t);return i}function v(e){return unescape(encodeURIComponent(e))}function m(e){return _(v(e))}function b(e){return y(m(e))}function E(e,t){return g(v(e),v(t))}function w(e,t){return y(E(e,t))}function T(e,t,n){return t?n?E(t,e):w(t,e):n?m(e):b(e)}void 0!==(r=function(){return T}.call(t,n,t,e))&&(e.exports=r)}()},function(e,t,n){"use strict";e.exports=function(){if("undefined"==typeof window)return null;var e={RTCPeerConnection:window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,RTCSessionDescription:window.RTCSessionDescription||window.mozRTCSessionDescription||window.webkitRTCSessionDescription,RTCIceCandidate:window.RTCIceCandidate||window.mozRTCIceCandidate||window.webkitRTCIceCandidate};return e.RTCPeerConnection?e:null}},function(e,t,n){"use strict";function r(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:120,r=null,i=!1,o=n;return function(){if(arguments.length>0&&void 0!==arguments[0]&&arguments[0])return void window.clearTimeout(r);i||(i=!0,r=setTimeout(function(){e.call(t),i=!1,r=null},1e3*o),o*=1.5)}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=r,e.exports=t.default},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=n(0),l=r(c),f=n(25),d=r(f),h=n(27),p=r(h),_=n(3),g=(n(1),n(6)),y=r(g),v=20,m=12,b=function(e){function t(e,n,r){o(this,t);var i=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.engine=e,i.logger=e.logger,i.config=r,i.connected=!1,i.scheduler=new d.default(e,r),i.DCMap=new Map,i.failedDCSet=new Set,i.signalerWs=null,i.fetcher=n,i.peers=[],i.minConns=0,i.requestMorePeers=(0,_.getPeersThrottle)(i._requestMorePeers,i),i.maxConns=y.default.isMobile()?m:v,i}return a(t,e),u(t,[{key:"resumeP2P",value:function(){var e=this;this.fetcher.btAnnounce().then(function(t){e.logger.info("announce request response "+JSON.stringify(t)),e.engine.peerId=e.peerId=t.id,e.minConns=t.min_conns,t.share_only&&e.scheduler&&e.scheduler.setShareOnly(),(t.wifi_only||e.engine.config.wifiOnly)&&"wifi"!==e.engine.netType&&(e.scheduler.downloadOnly=!0,e.logger.info("downloadOnly mode")),e.signalerWs=e._initSignalerWs(),0===t.peers.length?e.requestMorePeers():e._handlePeers(t.peers),e.engine.emit("peerId",e.peerId);var n=e.engine.config.getPeerId;n&&"function"==typeof n&&n(e.peerId)}).catch(function(t){e.logger.error(t)})}},{key:"stopP2P",value:function(){this.fetcher.destroy(),this.fetcher=null,this.requestMorePeers(!0),this.scheduler.destroy(),this.scheduler=null,this.signalerWs&&(this.signalerWs.destroy(),this.signalerWs=null),this.peers=[];var e=!0,t=!1,n=void 0;try{for(var r,i=this.DCMap.values()[Symbol.iterator]();!(e=(r=i.next()).done);e=!0){r.value.destroy()}}catch(e){t=!0,n=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw n}}this.DCMap.clear(),this.failedDCSet.clear(),this.logger.warn("tracker stop p2p")}},{key:"destroy",value:function(){this.stopP2P(),this.removeAllListeners(),this.logger.warn("destroy tracker")}},{key:"_handlePeers",value:function(e){var t=this,n=!0,r=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done);n=!0){var u=s.value;this.peers.push({id:u.id})}}catch(e){r=!0,o=e}finally{try{!n&&a.return&&a.return()}finally{if(r)throw o}}this.peers=this.peers.filter(function(e){for(var n=[].concat(i(t.DCMap.keys()),i(t.failedDCSet.keys())),r=0;r<n.length;r++){var o=n[r];if(e.id===o)return!1}return!0})}},{key:"_tryConnectToAllPeers",value:function(){var e=this;0!==this.peers.length&&(this.logger.info("try connect to "+this.peers.length+" peers"),this.peers.forEach(function(t){var n=new _.DataChannel(e.engine,e.peerId,t.id,!0,e.config);e.DCMap.set(t.id,n),e._setupDC(n)}),this.peers=[])}},{key:"_setupDC",value:function(e){var t=this;e.on(_.Events.DC_SIGNAL,function(n){var r=e.remotePeerId;t.signalerWs.sendSignal(r,n)}).once(_.Events.DC_ERROR,function(){t.logger.info("datachannel connect "+e.channelId+" failed"),t.scheduler&&t.scheduler.deletePeer(e),t.DCMap.delete(e.remotePeerId),t.failedDCSet.add(e.remotePeerId),e.destroy(),t.requestMorePeers(),e.connected&&t.fetcher?t.fetcher.decreConns():t.fetcher.increFailConns()}).once(_.Events.DC_CLOSE,function(){t.logger.info("datachannel "+e.channelId+" closed"),t.scheduler&&t.scheduler.deletePeer(e),t.DCMap.delete(e.remotePeerId),t.failedDCSet.add(e.remotePeerId),e.destroy(),t.requestMorePeers(),t.fetcher&&t.fetcher.decreConns()}).once(_.Events.DC_OPEN,function(){t.scheduler.handshakePeer(e);var n=t.scheduler.peersNum>t.minConns;t.requestMorePeers(n),t.fetcher.increConns()})}},{key:"_initSignalerWs",value:function(){var e=this,t=new p.default(this.engine,this.peerId,this.config);return t.onopen=function(){e.connected=!0,e.engine.emit("serverConnected",!0),e._tryConnectToAllPeers()},t.onmessage=function(t){var n=t.action;switch(n){case"signal":var r=t.from_peer_id;if(e.failedDCSet.has(r)||!r)return;if(e.logger.debug("handle signal of "+r),t.data)e._handleSignal(r,t.data);else{e.logger.info("signaling "+r+" not found");var i=e.DCMap.get(r);i&&(i.destroy(),e.DCMap.delete(r)),e.failedDCSet.add(r)}break;case"reject":e.stopP2P();break;default:e.logger.warn("Signaler websocket unknown action "+n)}},t.onclose=function(){e.connected=!1,e.engine.emit("serverConnected",!1)},t}},{key:"_handleSignal",value:function(e,t){var n=this.DCMap.get(e);if(n&&n.connected)return void this.logger.info("datachannel had connected, signal ignored");if(!n){if(this.logger.debug("receive node "+e+" connection request"),this.failedDCSet.has(e))return;if(this.scheduler.peersNum>this.maxConns)return void this.logger.info("Peers num excess MAX_CONNS "+this.maxConns);n=new _.DataChannel(this.engine,this.peerId,e,!1,this.config),this.DCMap.set(e,n),this._setupDC(n)}n.receiveSignal(t)}},{key:"_requestMorePeers",value:function(){var e=this;this.scheduler.peersNum<=this.minConns&&this.fetcher.btGetPeers([].concat(i(this.DCMap.keys()),i(this.failedDCSet.keys()))).then(function(t){e.logger.info("request more peers "+JSON.stringify(t)),e._handlePeers(t.peers),e._tryConnectToAllPeers()}).catch(function(t){e.logger.error("_requestMorePeers error "+t)})}}]),t}(l.default);t.default=b,e.exports=t.default},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function u(e){return 0===e?g:.33*e+.67}Object.defineProperty(t,"__esModule",{value:!0});var c=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),l=n(0),f=r(l),d=n(3),h=n(26),p=r(h),_=n(1),g=3,y=50,v=5,m=Symbol("shareOnly"),b=function(e){function t(e,n){o(this,t);var r=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r.engine=e,r.config=n,r.bufMgr=null,r.peerManager=new p.default,r.bitset=new Set,r.bitCounts=new Map,r.targetPeer=null,r._setupEngine(),r.currPlaySN=0,r.currLostSN=-1,r.checkTimer=null,r.loadedPeerNum=0,r.config.live?r.maxPrefetchCount=v:(r.maxPrefetchCount=y,r.startCheckPeersTimer()),r.startCheckConnsTimer(),r.requestingMap=new Map,r.dcDownloadTimeout=n.dcDownloadTimeout,r.mBufferedDuration=0,r[m]=!1,r.downloadOnly=!1,r}return a(t,e),c(t,[{key:"startCheckPeersTimer",value:function(){var e=this,t=u(this.loadedPeerNum);this.engine.logger.info("loaded peers "+this.loadedPeerNum+" next checkDelay is "+t),this.loadedPeerNum=0,this.checkTimer=window.setTimeout(function(){e.checkPeers(),e.startCheckPeersTimer()},1e3*t)}},{key:"startCheckConnsTimer",value:function(){var e=this;this.checkConnsTimer=window.setInterval(function(){var t=(0,_.getCurrentTs)(),n=!0,r=!1,i=void 0;try{for(var o,s=e.peerManager.getPeerValues()[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var a=o.value,u=t-a.dataExchangeTs;u>300&&e.peersNum>=6&&(e.engine.logger.warn("peer "+a.remotePeerId+" idle for "+u+", close it"),a.close())}}catch(e){r=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}},15e3)}},{key:"updateLoadedSN",value:function(e){this.bitset.add(e),this.bitCounts.has(e)&&this.bitCounts.delete(e);var t={event:d.Events.DC_HAVE,sn:e};this._broadcastToPeers(t)}},{key:"updatePlaySN",value:function(e){this.engine.logger.info("updatePlaySN "+e),this.currPlaySN=e}},{key:"checkPeers",value:function(){var e=this.engine.logger;if(!(this.currLostSN>=0&&this.currLostSN>=this.currPlaySN-5)&&this.hasPeers){var t=this.peerManager.getAvailablePeers();if(0!==t.length){var n=[],r=this.config.prefetchNum,o=0,s=this.loadingSN+1,a=this.loadingSN+80;if(!this.config.live){var u=Math.min.apply(Math,i(t.filter(function(e){return e.endSN>=s}).map(function(e){return e?e.startSN:1/0})));if(!isFinite(u))return;s<u&&(s=u)}for(;n.length<=r&&n.length<t.length&&o<this.maxPrefetchCount;){if(!this.config.live&&s>a)return;if(this.bitset.has(s))s++;else{if(s!==this.loadingSN&&this.bitCounts.has(s)&&!this.requestingMap.has(s)){var c=!0,l=!1,f=void 0;try{for(var d,h=t[Symbol.iterator]();!(c=(d=h.next()).done);c=!0){var p=d.value;if(!n.includes(p)&&p.bitset.has(s)){p.requestDataBySN(s,!1),e.info("request prefetch "+s+" from peer "+p.remotePeerId+" downloadNum "+p.downloadNum),n.push(p),this.requestingMap.set(s,p.remotePeerId);break}}}catch(e){l=!0,f=e}finally{try{!c&&h.return&&h.return()}finally{if(l)throw f}}}o++,s++}}this.loadedPeerNum=n.length}}}},{key:"chokePeerRequest",value:function(e){var t={event:d.Events.DC_CHOKE};e?e.sendJson(t):this._broadcastToPeers(t)}},{key:"unchokePeerRequest",value:function(e){var t={event:d.Events.DC_UNCHOKE};e?e.sendJson(t):this._broadcastToPeers(t)}},{key:"stopRequestFromPeers",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,i=this.peerManager.getPeerValues()[Symbol.iterator]();!(e=(r=i.next()).done);e=!0){r.value.choked=!0}}catch(e){t=!0,n=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw n}}}},{key:"resumeRequestFromPeers",value:function(){var e=!0,t=!1,n=void 0;try{for(var r,i=this.peerManager.getPeerValues()[Symbol.iterator]();!(e=(r=i.next()).done);e=!0){r.value.choked=!1}}catch(e){t=!0,n=e}finally{try{!e&&i.return&&i.return()}finally{if(t)throw n}}}},{key:"setShareOnly",value:function(){this[m]=!0}},{key:"deletePeer",value:function(e){var t=this;this.peerManager.hasPeer(e.remotePeerId)&&(this.peerManager.removePeer(e.remotePeerId),e.bitset.forEach(function(e){t._decreBitCounts(e)})),this._peersStats(this.peerManager.getPeerIds())}},{key:"handshakePeer",value:function(e){this._setupDC(e),e.sendBitField(Array.from(this.bitset))}},{key:"addPeer",value:function(e){this.engine.logger.debug("add peer "+e.remotePeerId),this.peerManager.addPeer(e.remotePeerId,e),this[m]&&(e.choked=!0),this._peersStats(this.peerManager.getPeerIds())}},{key:"peersHasSN",value:function(e){return this.bitCounts.has(e)}},{key:"hasAndSetTargetPeer",value:function(e){var t=this.engine.logger;if(this.bufferedDuration<=5)return!1;if(this.requestingMap.has(e))return!0;if(!this.hasIdlePeers||!this.peersHasSN(e))return!1;var n=!0,r=!1,i=void 0;try{for(var o,s=this.peerManager.getPeersOrderByWeight()[Symbol.iterator]();!(n=(o=s.next()).done);n=!0){var a=o.value;if(a.bitset.has(e))return t.info("found sn "+e+" from peer "+a.remotePeerId),this.targetPeer=a,!0}}catch(e){r=!0,i=e}finally{try{!n&&s.return&&s.return()}finally{if(r)throw i}}return t.info("idle peers hasn't sn "+e+" or busy"),!1}},{key:"load",value:function(e){var t=this.engine.logger;this.request=e.request;var n=this.request,r=n.sn,i=n.level,o=n.url,s=this.config.segmentId(i,r,o);this.callbacks=e,this.criticalSeg={sn:r,segId:s};var a=this.mBufferedDuration-5;a>this.dcDownloadTimeout?a=this.dcDownloadTimeout:a<3&&(a=3),this.requestingMap.has(r)?t.info("wait for criticalSeg segId "+s+" at "+r+" timeout "+a):(this.targetPeer.requestDataById(s,r,!0),t.info("request criticalSeg segId "+s+" at "+r+" timeout "+a)),this.criticaltimeouter=window.setTimeout(this._criticaltimeout.bind(this),1e3*a)}},{key:"destroy",value:function(){var e=this.engine.logger;this.peersNum>0&&this.peerManager.clear(),this.removeAllListeners(),this.checkTimer&&(window.clearTimeout(this.checkTimer),this.checkTimer=null),this.checkConnsTimer&&(window.clearInterval(this.checkConnsTimer),this.checkConnsTimer=null),e.warn("destroy scheduler")}},{key:"_setupDC",value:function(e){var t=this,n=this.engine.logger;e.on(d.Events.DC_METADATA,function(n){n.field&&(e.bitset=new Set(n.field),n.field.forEach(function(e){t.bitset.has(e)||t._increBitCounts(e)}),t.addPeer(e),t.downloadOnly&&t.chokePeerRequest(e))}).on(d.Events.DC_HAVE,function(n){if(n.sn&&e.bitset){var r=n.sn;if(e.bitset.add(r),t.bitset.has(r)||t._increBitCounts(r),t.config.live){var i=r-60;i>0&&e.bitset.delete(i)}}}).on(d.Events.DC_LOST,function(n){if(n.sn&&e.bitset){var r=n.sn;e.bitset.delete(r),t._decreBitCounts(r)}}).on(d.Events.DC_PIECE_ACK,function(e){e.size&&t.engine.fetcher.reportUploaded(e.size)}).on(d.Events.DC_PIECE,function(e){}).on(d.Events.DC_PIECE_NOT_FOUND,function(r){t.criticalSeg&&t.criticalSeg.segId===r.seg_id&&(window.clearTimeout(t.criticaltimeouter),n.info("DC_PIECE_NOT_FOUND"),t.callbacks.onTimeout()),e.bitset.delete(r.sn),t.requestingMap.delete(r.sn),t._decreBitCounts(r.sn)}).on(d.Events.DC_RESPONSE,function(r){var i=r.level,o=r.sn,s=r.data,a=r.seg_id,u=t.criticalSeg&&t.criticalSeg.segId===a;t.config.validateSegment(i,o,s)?(u?(n.info("receive criticalSeg seg_id "+a),window.clearTimeout(t.criticaltimeouter),t.criticaltimeouter=null,e.miss=0,t.criticalSeg=null,t.request.fromPeerId=e.remotePeerId,t.request.loadByP2P=!0,t.callbacks.success(r.data)):(t.bufMgr.handleFrag(o,i,a,s,e.remotePeerId,!1),t.updateLoadedSN(o)),t.requestingMap.delete(o)):(n.warn("segment "+i+"-"+o+" validate failed"),u&&(window.clearTimeout(t.criticaltimeouter),t._criticaltimeout()))}).on(d.Events.DC_REQUEST,function(n){var r="";if((r=n.seg_id?n.seg_id:t.bufMgr.getSegIdbySN(n.sn))&&t.bufMgr.hasSegOfId(r)){var i=t.bufMgr.getSegById(r);e.sendBuffer(i.sn,i.level,i.segId,i.data)}else e.sendJson({event:d.Events.DC_PIECE_NOT_FOUND,seg_id:r,sn:n.sn})}).on(d.Events.DC_TIMEOUT,function(e){})}},{key:"_setupEngine",value:function(){var e=this;this.engine.on(d.Events.FRAG_LOADING,function(t){e.loadingSN=t,e.config.live&&e.checkPeers()}).on(d.Events.FRAG_LOADED,function(t,n){e.updateLoadedSN(t)}).on(d.Events.FRAG_CHANGED,function(t,n){e.updatePlaySN(t)})}},{key:"_broadcastToPeers",value:function(e){var t=!0,n=!1,r=void 0;try{for(var i,o=this.peerManager.getPeerValues()[Symbol.iterator]();!(t=(i=o.next()).done);t=!0){i.value.sendJson(e)}}catch(e){n=!0,r=e}finally{try{!t&&o.return&&o.return()}finally{if(n)throw r}}}},{key:"_getIdlePeer",value:function(){return this.peerManager.getAvailablePeers()}},{key:"_decreBitCounts",value:function(e){if(this.bitCounts.has(e)){var t=this.bitCounts.get(e);1===t?this.bitCounts.delete(e):this.bitCounts.set(e,t-1)}}},{key:"_increBitCounts",value:function(e){if(this.bitCounts.has(e)){var t=this.bitCounts.get(e);this.bitCounts.set(e,t+1)}else this.bitCounts.set(e,1)}},{key:"_criticaltimeout",value:function(){var e=this,t=this.engine.logger;if(this.criticalSeg){var n=this.criticalSeg.sn;if(t.info("critical request sn "+n+" timeout"),this.requestingMap.has(n)&&(this.targetPeer=this.peerManager.getPeer(this.requestingMap.get(n))),this.config.httpRangeSupported&&this.targetPeer&&this.targetPeer.bufSN===n&&this.targetPeer.bufArr.length>0){var r=d.Buffer.concat(this.targetPeer.bufArr),i=this.request.url;t.info("continue download from "+i+" range: "+r.byteLength+"-"),fetch(i,{headers:{Range:"bytes="+r.byteLength+"-"}}).then(function(e){return e.arrayBuffer()}).then(function(t){var n=d.Buffer.from(t);e.engine.fetcher.reportFlow(n.byteLength);var i=d.Buffer.concat([r,n]),o=new Uint8Array(i).buffer;e.request.fromPeerId=e.targetPeer.remotePeerId,e.request.loadByP2P=!0,e.callbacks.success(o)}).catch(function(n){t.error("http partial download error "+n),e.callbacks.onTimeout()})}else this.callbacks.onTimeout(),this.targetPeer&&this.targetPeer.loadtimeout();this.criticalSeg=null,this.criticaltimeouter=null}}},{key:"_peersStats",value:function(e){this.engine.emit("peers",e);var t=this.engine.config.getPeersInfo;t&&"function"==typeof t&&t(e)}},{key:"hasPeers",get:function(){return this.peersNum>0}},{key:"peersNum",get:function(){return this.peerManager.size()}},{key:"hasIdlePeers",get:function(){var e=this.engine.logger,t=this._getIdlePeer().length;return e.info("peers: "+this.peersNum+" idle peers: "+t),t>0}},{key:"bufferedDuration",get:function(){for(var e=this.engine.media,t=0,n=e.currentTime,r=e.buffered,i=r.length-1;i>=0;i--)if(n>=r.start(i)&&n<=r.end(i)){t=r.end(i)-n;break}return this.engine.logger.info("bufferedDuration "+t),this.mBufferedDuration=t,t>0?t:0}},{key:"bufferManager",set:function(e){var t=this;this.bufMgr=e,e.on(d.Events.BM_LOST,function(e){t.currLostSN=e,t.config.live||t._broadcastToPeers({event:d.Events.DC_LOST,sn:e}),t.bitset.delete(e),t.bitCounts.delete(e)})}}]),t}(f.default);t.default=b,e.exports=t.default},function(e,t,n){"use strict";function r(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var o=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),s=function(){function e(){i(this,e),this.peerMap=new Map}return o(e,[{key:"isEmpty",value:function(){return 0===this.peerMap.size}},{key:"size",value:function(){return this.peerMap.size}},{key:"clear",value:function(){this.peerMap.clear()}},{key:"getPeers",value:function(){return[].concat(r(this.peerMap.values()))}},{key:"getPeerValues",value:function(){return this.peerMap.values()}},{key:"hasPeer",value:function(e){return this.peerMap.has(e)}},{key:"addPeer",value:function(e,t){this.peerMap.set(e,t)}},{key:"getPeerIds",value:function(){return[].concat(r(this.peerMap.keys()))}},{key:"removePeer",value:function(e){this.peerMap.delete(e)}},{key:"getPeersOrderByWeight",value:function(){var e=this.getPeers().filter(function(e){return e.isAvailableUrgently});return e.sort(function(e,t){return 0===t.weight?1:0===e.weight?-1:t.weight-e.weight}),e}},{key:"getPeer",value:function(e){return this.peerMap.get(e)}},{key:"getAvailablePeers",value:function(){return this.getPeers().filter(function(e){return e.isAvailable})}}]),e}();t.default=s,e.exports=t.default},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),u=n(0),c=r(u),l=n(28),f=r(l),d=n(1),h=function(e){function t(e,n,r){i(this,t);var s=o(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return s.compressed=!1,s.engine=e,s.logger=e.logger,s.peerId=n,s.config=r,s.wsAddr=r.wsSignalerAddr,s.connected=!1,s._ws=s._init(n),s}return s(t,e),a(t,[{key:"_init",value:function(e){var t=this,n={maxRetries:this.config.wsMaxRetries,minReconnectionDelay:1e3*(0,d.randomNum)(this.config.wsReconnectInterval,60),maxReconnectionDelay:3e5},r="?id="+e,i=new f.default(this.wsAddr+r,void 0,n);return i.onopen=function(){t.logger.info("Signaler websocket connection opened"),t.connected=!0,t.onopen&&t.onopen(),t._startPing()},i.push=i.send,i.send=function(e){var n=JSON.stringify(e);i.push(n),t._resetPing()},i.onmessage=function(e){var n=e.data,r=JSON.parse(n);"compress"===r.action?r.supported&&(t.logger.info("signal compress is supported"),t.compressed=!0,i.binaryType="arraybuffer"):t.onmessage&&t.onmessage(r)},i.onclose=function(e){t.logger.warn("Signaler websocket closed "+e.code+" "+e.reason),t.onclose&&t.onclose(),t.connected=!1,t._stopPing()},i.onerror=function(e){t.logger.error("Signaler websocket error")},i}},{key:"sendSignal",value:function(e,t){var n={action:"signal",to_peer_id:e,data:t};this._send(n)}},{key:"_send",value:function(e){this.connected?this._ws.send(e):this.logger.warn("signaler closed, send msg failed")}},{key:"_askCompress",value:function(){if(this.config.signalCompressed){var e={action:"compress",supported:!0};this._send(e)}}},{key:"_startPing",value:function(){var e=this;this.pingTimer=window.setInterval(function(){var t={action:"heartbeat"};e._send(t)},12e4)}},{key:"_resetPing",value:function(){this._stopPing(),this._startPing()}},{key:"_stopPing",value:function(){window.clearInterval(this.pingTimer),this.pingTimer=null}},{key:"close",value:function(){this.logger.warn("close signal client"),this.connected=!1,this._ws.close(1e3,"stop signaling",{keepClosed:!0})}},{key:"destroy",value:function(){this.close(),this._ws=null,this.removeAllListeners(),this.logger.warn("destroy signaler")}}]),t}(c.default);t.default=h,e.exports=t.default},function(e,t,n){"use strict";var r=function(e){return e&&2===e.CLOSING},i=function(){return"undefined"!=typeof WebSocket&&r(WebSocket)},o=function(){return{constructor:i()?WebSocket:null,maxReconnectionDelay:1e4,minReconnectionDelay:1500,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,debug:!1}},s=function(e,t,n){Object.defineProperty(t,n,{get:function(){return e[n]},set:function(t){e[n]=t},enumerable:!0,configurable:!0})},a=function(e){return e.minReconnectionDelay+Math.random()*e.minReconnectionDelay},u=function(e,t){var n=t*e.reconnectionDelayGrowFactor;return n>e.maxReconnectionDelay?e.maxReconnectionDelay:n},c=["onopen","onclose","onmessage","onerror"],l=function(e,t,n){Object.keys(n).forEach(function(t){n[t].forEach(function(n){var r=n[0],i=n[1];e.addEventListener(t,r,i)})}),t&&c.forEach(function(n){e[n]=t[n]})},f=function e(t,n,i){var c=this;void 0===i&&(i={});var f,d,h=0,p=0,_=!0,g=null,y={};if(!(this instanceof e))throw new TypeError("Failed to construct 'ReconnectingWebSocket': Please use the 'new' operator");var v=o();if(Object.keys(v).filter(function(e){return i.hasOwnProperty(e)}).forEach(function(e){return v[e]=i[e]}),!r(v.constructor))throw new TypeError("Invalid WebSocket constructor. Set `options.constructor`");var m=v.debug?function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return console.log.apply(console,["RWS:"].concat(e))}:function(){},b=function(e,t){return setTimeout(function(){var n=new Error(t);n.code=e,Array.isArray(y.error)&&y.error.forEach(function(e){return(0,e[0])(n)}),f.onerror&&f.onerror(n)},0)},E=function(){if(m("handleClose",{shouldRetry:_}),p++,m("retries count:",p),p>v.maxRetries)return void b("EHOSTDOWN","Too many failed connection attempts");h=h?u(v,h):a(v),m("handleClose - reconnectDelay:",h),_&&setTimeout(w,h)},w=function(){if(_){m("connect");var e=f,r="function"==typeof t?t():t;f=new v.constructor(r,n),d=setTimeout(function(){m("timeout"),f.close(),b("ETIMEDOUT","Connection timeout")},v.connectionTimeout),m("bypass properties");for(var i in f)["addEventListener","removeEventListener","close","send"].indexOf(i)<0&&s(f,c,i);f.addEventListener("open",function(){clearTimeout(d),m("open"),h=a(v),m("reconnectDelay:",h),p=0}),f.addEventListener("close",E),l(f,e,y),f.onclose=f.onclose||g,g=null}};m("init"),w(),this.close=function(e,t,n){void 0===e&&(e=1e3),void 0===t&&(t="");var r=void 0===n?{}:n,i=r.keepClosed,o=void 0!==i&&i,s=r.fastClose,a=void 0===s||s,u=r.delay,c=void 0===u?0:u;if(m("close - params:",{reason:t,keepClosed:o,fastClose:a,delay:c,retriesCount:p,maxRetries:v.maxRetries}),_=!o&&p<=v.maxRetries,c&&(h=c),f.close(e,t),a){var l={code:e,reason:t,wasClean:!0};E(),f.removeEventListener("close",E),Array.isArray(y.close)&&y.close.forEach(function(e){var t=e[0],n=e[1];t(l),f.removeEventListener("close",t,n)}),f.onclose&&(g=f.onclose,f.onclose(l),f.onclose=null)}},this.send=function(e){f.send(e)},this.addEventListener=function(e,t,n){Array.isArray(y[e])?y[e].some(function(e){return e[0]===t})||y[e].push([t,n]):y[e]=[[t,n]],f.addEventListener(e,t,n)},this.removeEventListener=function(e,t,n){Array.isArray(y[e])&&(y[e]=y[e].filter(function(e){return e[0]!==t})),f.removeEventListener(e,t,n)}};e.exports=f},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=n(4),i=(function(e){e&&e.__esModule}(r),{wsMaxRetries:15,wsReconnectInterval:30,p2pEnabled:!0,wifiOnly:!1,memoryCacheLimit:{pc:536870912,mobile:268435456},dcDownloadTimeout:25,logLevel:"error",tag:"",webRTCConfig:{},token:"free",appName:void 0,appId:void 0,signalCompressed:!1,prefetchNum:10,channelIdPrefix:""});i.validateSegment=function(e,t,n){return!0},i.getStats=function(e,t,n){},i.getPeerId=function(e){},i.getPeersInfo=function(e){},t.default=i,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},i=n(3),o=r({},i.config);o.segmentId=function(e,t,n){return""+n.split("?")[0]},t.default=o,e.exports=t.default},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(1),s={debug:0,info:1,warn:2,error:3,none:4},a=["_debugP","_infoP","_warnP","_errorP"],u=function(){function e(t){r(this,e),"debug"!==t.logLevel&&"info"!==t.logLevel||(t.logLevel="info"),"1"===(0,o.getQueryParam)("_debug")?t.logLevel="info":!0===t.logLevel?t.logLevel="warn":!1===t.logLevel?t.logLevel="none":t.logLevel in s||(t.logLevel="error");for(var n=0;n<s[t.logLevel];n++)this[a[n]]=o.noop}return i(e,[{key:"debug",value:function(e){this._debugP(e)}},{key:"info",value:function(e){this._infoP(e)}},{key:"warn",value:function(e){this._warnP(e)}},{key:"error",value:function(e){this._errorP(e)}},{key:"_debugP",value:function(e){console.log(e)}},{key:"_infoP",value:function(e){console.info(e)}},{key:"_warnP",value:function(e){console.warn(e)}},{key:"_errorP",value:function(e){console.error(e)}}]),e}();t.default=u,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(){var e="unknown";for(var t in r)if(window[t]){e=r[t];break}return e};var r={DPlayer:"dplayer",CBPlayer:"cbplayer",jwplayer:"jwplayer",videojs:"videojs",Clappr:"clappr",ckplayer:"ckplayer",MediaElementPlayer:"mediaelement",MediaElement:"mediaelement",TcPlayer:"tcplayer",flowplayer:"flowplayer",Chimee:"chimee",ChimeePlayer:"chimee",HlsJsPlayer:"xgplayer",fluidPlayer:"fluidplayer",OpenPlayer:"openplayer",Plyr:"plyr",Playerjs:"playerjs"};e.exports=t.default},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var u=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),c=n(0),l=r(c),f=n(3),d=n(6),h=r(d),p=104857600,_=function(e){function t(e,n){o(this,t);var r=s(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));r.logger=n.logger;var i=e.browserInfo.device;return r.maxBufSize=i===h.default.device.PC_WEB||i===h.default.device.PC_NATIVE?n.memoryCacheLimit.pc:n.memoryCacheLimit.mobile,n.live&&(r.maxBufSize=p),r._segPool=new Map,r._currBufSize=0,r.sn2Id=new Map,r.overflowed=!1,r}return a(t,e),u(t,[{key:"hasSegOfId",value:function(e){return this._segPool.has(e)}},{key:"hasSegOfSN",value:function(e){return this.sn2Id.has(e)}},{key:"handleFrag",value:function(e,t,n,r){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"",o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=void 0,a=r.byteLength;if(o){var u=f.Buffer.from(r);s=new f.Buffer(a),u.copy(s)}else s=r;var c={sn:e,level:t,segId:n,data:s,size:a,fromPeerId:i};this._addSeg(c),this.sn2Id.set(e,c.segId)}},{key:"_addSeg",value:function(e){var t=this.logger;for(this._segPool.set(e.segId,e),t.info("segment pool add seg "+e.segId+" level "+e.level),this._currBufSize+=parseInt(e.size),t.debug("seg.size "+e.size+" _currBufSize "+this._currBufSize+" cacheLimit "+this.maxBufSize);this._currBufSize>this.maxBufSize;){var n=[].concat(i(this._segPool.values())).shift();t.info("pop seg "+n.segId+" at "+n.sn),this._segPool.delete(n.segId),this.sn2Id.delete(n.sn),this._currBufSize-=parseInt(n.size),this.overflowed||(this.overflowed=!0),this.emit(f.Events.BM_LOST,n.sn)}}},{key:"getSegById",value:function(e){return this._segPool.get(e)}},{key:"getSegIdbySN",value:function(e){return this.sn2Id.get(e)}},{key:"clear",value:function(){this._segPool.clear(),this.sn2Id.clear(),this._currBufSize=0}},{key:"destroy",value:function(){this.clear(),this.removeAllListeners()}},{key:"currBufSize",get:function(){return this._currBufSize}}]),t}(l.default);t.default=_,e.exports=t.default},function(e,t,n){"use strict";(function(r){function i(e){return e&&e.__esModule?e:{default:e}}function o(){return function(e){function t(e){var t=function(t){p.trigger(y.default.CHECK_FOR_EXISTENCE_COMPLETED,{request:e,exists:t})};if(e){var n=new l.default(e.url);v.load({request:n,success:function(){t(!0)},error:function(){t(!1)}})}else t(!1)}function n(e){var t=function(t,n){p.trigger(y.default.LOADING_COMPLETED,{request:e,response:t||null,error:n||null,sender:h})},n={request:e,progress:function(t){p.trigger(y.default.LOADING_PROGRESS,{request:e,stream:t.stream}),t.data&&p.trigger(y.default.LOADING_DATA_PROGRESS,{request:e,response:t.data||null,error:null,sender:g})},success:function(e){t(e)},error:function(e,n,r){t(void 0,new d.default(m.default.FRAGMENT_LOADER_LOADING_FAILURE_ERROR_CODE,r,n))},abort:function(e){e&&p.trigger(y.default.LOADING_ABANDONED,{request:e,mediaType:e.mediaType,sender:g})},onTimeout:function(){}};if(e){if("video"!==e.mediaType||isNaN(e.index)||!p2pConfig.isReady)return e.loadByHTTP=!0,void v.load(n);var i=e.quality,o=e.index,u=e.url,l=e.representationId,f=p2pConfig.segmentId(i,o,u);if(e.sn=o,e.level=i,p2pConfig.p2pEnabled&&p2pConfig.bufMgr.hasSegOfId(f)){a.info("bufMgr found seg sn "+o+" url "+l);var _=p2pConfig.bufMgr.getSegById(f),b=s.Buffer.from(_.data),E=new s.Buffer(_.data.byteLength);b.copy(E);var w=new Uint8Array(E).buffer,T={url:c.url,data:w};e.loadByP2P=!0,e.fromPeerId=_.fromPeerId,e.bytesLoaded=e.bytesTotal=T.data.byteLength,a.debug("bufMgr loaded "+l+" at "+o),r.nextTick(function(){n.success(T.data)})}else if(p2pConfig.p2pEnabled&&p2pConfig.scheduler.hasAndSetTargetPeer(o)){p2pConfig.scheduler.load(n);var C=n.onTimeout;n.onTimeout=function(){a.info("P2P timeout switched to HTTP load "+l+" at "+o),v.load(n),n.onTimeout=C};var P=n.success;n.success=function(t){n.success=function(){a.warn("p2p loaded "+o+", http ignore")},p2pConfig.bufMgr.hasSegOfId(f)||p2pConfig.bufMgr.handleFrag(o,i,f,t,e.fromPeerId||p2pConfig.fetcher.peerId,!0),e.loadByP2P||p2pConfig.fetcher.reportFlow(t.byteLength),a.info((e.loadByP2P?"P2P":"HTTP")+" loaded segment id "+f),e.bytesLoaded=e.bytesTotal=t.byteLength,P(t)}}else{a.info("HTTP load "+l+" at "+o+" level "+i),e.loadByHTTP=!0,v.load(n);var O=n.success;n.success=function(e){p2pConfig.bufMgr.hasSegOfId(f)||p2pConfig.bufMgr.handleFrag(o,i,f,e,p2pConfig.fetcher.peerId,!0),p2pConfig.fetcher.reportFlow(e.byteLength),a.info("HTTP loaded "+f),O(e)}}}else t(void 0,new d.default(m.default.FRAGMENT_LOADER_NULL_REQUEST_ERROR_CODE,m.default.FRAGMENT_LOADER_NULL_REQUEST_ERROR_MESSAGE))}function i(){v&&v.abort()}function o(){v&&(v.abort(),v=null)}p2pConfig=window.__p2p_config__;var a=p2pConfig.logger;e=e||{};var c=this.context,f=this.factory,h=this.parent,p=f.getSingletonInstance(c,"EventBus"),g=void 0,v=void 0;return g={checkForExistence:t,load:n,abort:i,reset:o},function(){var t=(0,_.default)(c).getInstance();v=(0,u.default)(c).create({errHandler:e.errHandler,dashMetrics:e.dashMetrics,mediaPlayerModel:e.mediaPlayerModel,requestModifier:e.requestModifier,boxParser:t,useFetch:e.settings.get().streaming.lowLatencyEnabled})}(),g}}Object.defineProperty(t,"__esModule",{value:!0});var s=n(3),a=n(35),u=i(a),c=n(39),l=i(c),f=n(11),d=i(f),h=n(12),p=(i(h),n(41)),_=i(p),g=n(13),y=i(g),v=n(10),m=i(v);t.default=o,e.exports=t.default}).call(t,n(8))},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e){function t(e,n){var r=e.request,i=[],p=!0,y=!0,w=new Date,T=w,C=0,P=void 0;if(!d||!u||!s)throw new Error("config object is not correct or missing");var O=function(e){y=!1,r.requestStartDate=w,r.requestEndDate=new Date,r.firstByteDate=r.firstByteDate||w,r.checkExistenceOnly||(u.addHttpRequest(r,P.response?P.response.responseURL:null,P.response?P.response.status:null,P.response&&P.response.getAllResponseHeaders?P.response.getAllResponseHeaders():P.response?P.response.responseHeaders:[],e?i:null),r.type===l.HTTPRequest.MPD_TYPE&&u.addManifestUpdate(r.type,r.requestStartDate,r.requestEndDate))},R=function(){if(-1!==v.indexOf(P)&&(v.splice(v.indexOf(P),1),y))if(O(!1),n>0){n--;var i={config:e};b.push(i),i.timeout=setTimeout(function(){-1!==b.indexOf(i)&&(b.splice(b.indexOf(i),1),t(e,n))},f.getRetryIntervalsForType(r.type))}else s.error(new g.default(E[r.type],r.url+" is not available",{request:r,response:P.response})),e.error&&e.error(r,"error",P.response.statusText),e.complete&&e.complete(r,P.response.statusText)},S=function(t){var n=new Date;p&&(p=!1,(!t.lengthComputable||t.lengthComputable&&t.total!==t.loaded)&&(r.firstByteDate=n)),t.lengthComputable&&(r.bytesLoaded=t.loaded,r.bytesTotal=t.total),t.noTrace||(i.push({s:T,d:t.time?t.time:n.getTime()-T.getTime(),b:[t.loaded?t.loaded-C:0]}),T=n,C=t.loaded),e.progress&&t&&e.progress(t)},A=function(){P.response.status>=200&&P.response.status<=299&&(O(!0),e.success&&e.success(P.response.response,P.response.statusText,P.response.responseURL),e.complete&&e.complete(r,P.response.statusText))},D=function(){e.abort&&e.abort(r)},I=void 0;I=_&&window.fetch&&"arraybuffer"===r.responseType&&r.type===l.HTTPRequest.MEDIA_SEGMENT_TYPE?(0,c.default)(o).create({requestModifier:d,boxParser:h}):(0,a.default)(o).create({requestModifier:d});var L=d.modifyRequestURL(r.url),N=r.checkExistenceOnly?l.HTTPRequest.HEAD:l.HTTPRequest.GET,k=f.getXHRWithCredentialsForType(r.type);P={url:L,method:N,withCredentials:k,request:r,onload:A,onend:R,onerror:R,progress:S,onabort:D,loader:I};var x=(new Date).getTime();if(isNaN(r.delayLoadingTime)||x>=r.delayLoadingTime)v.push(P),I.load(P);else{var F={httpRequest:P};m.push(F),F.delayTimeout=setTimeout(function(){if(-1!==m.indexOf(F)){m.splice(m.indexOf(F),1);try{w=new Date,T=w,v.push(F.httpRequest),I.load(F.httpRequest)}catch(e){F.httpRequest.onerror()}}},r.delayLoadingTime-x)}}function n(e){e.request?t(e,f.getRetryAttemptsForType(e.request.type)):e.error&&e.error(e.request,"error")}function r(){b.forEach(function(e){clearTimeout(e.timeout),e.config.request&&e.config.abort&&e.config.abort(e.config.request)}),b=[],m.forEach(function(e){return clearTimeout(e.delayTimeout)}),m=[],v.forEach(function(e){e.onloadend=e.onerror=e.onprogress=void 0,e.loader.abort(e)}),v=[]}e=e||{};var o=this.context,s=e.errHandler,u=e.dashMetrics,f=e.mediaPlayerModel,d=e.requestModifier,h=e.boxParser,_=e.useFetch||!1,y=void 0,v=void 0,m=void 0,b=void 0,E=void 0;return y={load:n,abort:r},function(){var e;v=[],m=[],b=[],e={},i(e,l.HTTPRequest.MPD_TYPE,p.default.DOWNLOAD_ERROR_ID_MANIFEST_CODE),i(e,l.HTTPRequest.XLINK_EXPANSION_TYPE,p.default.DOWNLOAD_ERROR_ID_XLINK_CODE),i(e,l.HTTPRequest.INIT_SEGMENT_TYPE,p.default.DOWNLOAD_ERROR_ID_INITIALIZATION_CODE),i(e,l.HTTPRequest.MEDIA_SEGMENT_TYPE,p.default.DOWNLOAD_ERROR_ID_CONTENT_CODE),i(e,l.HTTPRequest.INDEX_SEGMENT_TYPE,p.default.DOWNLOAD_ERROR_ID_CONTENT_CODE),i(e,l.HTTPRequest.BITSTREAM_SWITCHING_SEGMENT_TYPE,p.default.DOWNLOAD_ERROR_ID_CONTENT_CODE),i(e,l.HTTPRequest.OTHER_TYPE,p.default.DOWNLOAD_ERROR_ID_CONTENT_CODE),E=e}(),y}Object.defineProperty(t,"__esModule",{value:!0});var s=n(36),a=r(s),u=n(37),c=r(u),l=n(9),f=n(2),d=r(f),h=n(10),p=r(h),_=n(11),g=r(_);o.__dashjs_factory_name="HTTPLoader";var y=d.default.getClassFactory(o);t.default=y,e.exports=t.default},function(e,t,n){"use strict";function r(e){function t(e){var t=new Date,n=e.request,i=new XMLHttpRequest;i.open(e.method,e.url,!0),n.responseType&&(i.responseType=n.responseType),n.range&&i.setRequestHeader("Range","bytes="+n.range),n.requestStartDate||(n.requestStartDate=t),r&&(i=r.modifyRequestHeader(i)),i.withCredentials=e.withCredentials,i.onload=e.onload,i.onloadend=e.onend,i.onerror=e.onerror,i.onprogress=e.progress,i.onabort=e.onabort,i.send(),e.response=i}function n(e){var t=e.response;t.onloadend=t.onerror=t.onprogress=void 0,t.abort()}e=e||{};var r=e.requestModifier;return{load:t,abort:n}}Object.defineProperty(t,"__esModule",{value:!0});var i=n(2),o=function(e){return e&&e.__esModule?e:{default:e}}(i);r.__dashjs_factory_name="XHRLoader";var s=o.default.getClassFactory(r);t.default=s,e.exports=t.default},function(e,t,n){"use strict";function r(e){function t(e){var t=new Date,i=e.request,u=new Headers;i.range&&u.append("Range","bytes="+i.range),i.requestStartDate||(i.requestStartDate=t),s&&s.modifyRequestHeader({setRequestHeader:function(e,t){u.append(e,t)}});var c=void 0;"function"==typeof window.AbortController&&(c=new AbortController,e.abortController=c);var l={method:e.method,headers:u,credentials:e.withCredentials?"include":void 0,signal:c?c.signal:void 0};fetch(e.url,l).then(function(t){e.response||(e.response={}),e.response.status=t.status,e.response.statusText=t.statusText,e.response.responseURL=t.url,t.ok||e.onerror();var i="",s=!0,u=!1,c=void 0;try{for(var l,f=t.headers.keys()[Symbol.iterator]();!(s=(l=f.next()).done);s=!0){var d=l.value;i+=d+": "+t.headers.get(d)+"\n"}}catch(e){u=!0,c=e}finally{try{!s&&f.return&&f.return()}finally{if(u)throw c}}if(e.response.responseHeaders=i,!t.body)return t.arrayBuffer().then(function(t){e.response.response=t;var n={loaded:t.byteLength,total:t.byteLength,stream:!1};e.progress(n),e.onload(),e.onend()});var h=parseInt(t.headers.get("Content-Length"),10),p=0,_=!1,g=new Uint8Array,y=0;e.reader=t.body.getReader();var v=[];n(e,function t(i){var s=i.value;if(i.done)return g&&(e.progress({loaded:p,total:isNaN(h)?p:h,lengthComputable:!0,time:o(v,p),stream:!0}),e.response.response=g.buffer),e.onload(),void e.onend();if(s&&s.length>0){g=r(g,s),p+=s.length,v.push({ts:Date.now(),bytes:s.length});var u=a.findLastTopIsoBoxCompleted(["moov","mdat"],g,y);if(u.found){var c=u.lastCompletedOffset+u.size,l=void 0;c===g.length?(l=g,g=new Uint8Array):(l=new Uint8Array(g.subarray(0,c)),g=g.subarray(c)),e.progress({data:l.buffer,lengthComputable:!1,noTrace:!0}),y=0}else y=u.lastCompletedOffset,_||(e.progress({lengthComputable:!1,noTrace:!0}),_=!0)}n(e,t)})}).catch(function(t){e.onerror&&e.onerror(t)})}function n(e,t){e.reader.read().then(t).catch(function(t){e.onerror&&200===e.response.status&&e.onerror(t)})}function r(e,t){if(0===e.length)return t;var n=new Uint8Array(e.length+t.length);return n.set(e),n.set(t,e.length),n}function i(e){if(e.abortController)e.abortController.abort();else if(e.reader)try{e.reader.cancel()}catch(e){}}function o(e,t){if(e=e.filter(function(n){return n.bytes>t/4/e.length}),e.length>1){var n=0,r=(e[e.length-1].ts-e[0].ts)/e.length;return e.forEach(function(t,i){var o=e[i+1];if(o){var s=o.ts-t.ts;n+=s<r?s:0}}),n}return null}e=e||{};var s=e.requestModifier,a=e.boxParser;return{load:t,abort:i,calculateDownloadedTime:o}}Object.defineProperty(t,"__esModule",{value:!0});var i=n(2),o=function(e){return e&&e.__esModule?e:{default:e}}(i);r.__dashjs_factory_name="FetchLoader";var s=o.default.getClassFactory(r);t.default=s,e.exports=t.default},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(){r(this,e)}return i(e,[{key:"extend",value:function(e,t){if(e){var n=!!t&&t.override,r=!!t&&t.publicOnly;for(var i in e)!e.hasOwnProperty(i)||this[i]&&!n||r&&-1===e[i].indexOf("public_")||(this[i]=e[i])}}}]),e}();t.default=o,e.exports=t.default},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=n(40),a=function(e){return e&&e.__esModule?e:{default:e}}(s),u=function(e){function t(e){r(this,t);var n=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.url=e||null,n.checkForExistenceOnly=!0,n}return o(t,e),t}(a.default);t.default=u,e.exports=t.default},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=n(9),s=function(){function e(){r(this,e),this.action=e.ACTION_DOWNLOAD,this.startTime=NaN,this.mediaType=null,this.mediaInfo=null,this.type=null,this.duration=NaN,this.timescale=NaN,this.range=null,this.url=null,this.serviceLocation=null,this.requestStartDate=null,this.firstByteDate=null,this.requestEndDate=null,this.quality=NaN,this.index=NaN,this.availabilityStartTime=null,this.availabilityEndTime=null,this.wallStartTime=null,this.bytesLoaded=NaN,this.bytesTotal=NaN,this.delayLoadingTime=NaN,this.responseType="arraybuffer",this.representationId=null}return i(e,[{key:"isInitializationRequest",value:function(){return this.type&&this.type===o.HTTPRequest.INIT_SEGMENT_TYPE}},{key:"setInfo",value:function(e){this.type=e&&e.init?o.HTTPRequest.INIT_SEGMENT_TYPE:o.HTTPRequest.MEDIA_SEGMENT_TYPE,this.url=e&&e.url?e.url:null,this.range=e&&e.range?e.range.start+"-"+e.range.end:null,this.mediaType=e&&e.mediaType?e.mediaType:null}}]),e}();s.ACTION_DOWNLOAD="download",s.ACTION_COMPLETE="complete",t.default=s,e.exports=t.default},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(){function e(e){if(!e)return null;void 0===e.fileStart&&(e.fileStart=0);var t=d.default.parseBuffer(e),n=(0,u.default)(f).create();return n.setData(t),n}function t(e,t,n){if(void 0===n&&(n=0),!t||n+8>=t.byteLength)return new p.default(0,!1);for(var r=t instanceof ArrayBuffer?new Uint8Array(t):t,s=void 0,a=0;n<r.byteLength;){var u=i(r,n),c=o(r,n+4);if(0===u)break;n+u<=r.byteLength&&(e.indexOf(c)>=0?s=new p.default(n,!0,u):a=n+u),n+=u}return s||new p.default(a,!1)}function n(t){if(!t||0===t.byteLength)return{sampleList:[],lastSequenceNumber:NaN,totalDuration:NaN,numSequences:NaN};var n=e(t),r=n.getBoxes("moof"),i=n.getBoxes("mfhd"),o=void 0,s=void 0,a=void 0,u=void 0,c=void 0,l=void 0,f=void 0,d=void 0,h=void 0,p=void 0,_=void 0,g=void 0,y=void 0,v=void 0,m=void 0,b=void 0,E=void 0;b=n.getBoxes("moof").length,m=i[i.length-1].sequence_number,a=0,l=[];var w=-1,T=-1;for(_=0;_<r.length;_++){var C=r[_],P=C.getChildBoxes("traf");for(h=0;h<P.length;h++){var O=P[h],R=O.getChildBox("tfhd"),S=O.getChildBox("tfdt");c=S.baseMediaDecodeTime;var A=O.getChildBoxes("trun"),D=O.getChildBoxes("subs");for(p=0;p<A.length;p++){var I=A[p];for(a=I.sample_count,v=(R.base_data_offset||0)+(I.data_offset||0),d=0;d<a;d++){f=I.samples[d],o=void 0!==f.sample_duration?f.sample_duration:R.default_sample_duration,u=void 0!==f.sample_size?f.sample_size:R.default_sample_size,s=void 0!==f.sample_composition_time_offset?f.sample_composition_time_offset:0;var L={dts:c,cts:c+s,duration:o,offset:C.offset+v,size:u,subSizes:[u]};if(D)for(g=0;g<D.length;g++){var N=D[g];if(w<N.entry_count-1&&d>T&&(w++,T+=N.entries[w].sample_delta),d==T){L.subSizes=[];var k=N.entries[w];for(y=0;y<k.subsample_count;y++)L.subSizes.push(k.subsamples[y].subsample_size)}}l.push(L),v+=u,c+=o}}E=c-S.baseMediaDecodeTime}}return{sampleList:l,lastSequenceNumber:m,totalDuration:E,numSequences:b}}function r(t){var n=e(t),r=n?n.getBox("mdhd"):void 0;return r?r.timescale:NaN}function i(e,t){return e[t+3]>>>0|e[t+2]<<8>>>0|e[t+1]<<16>>>0|e[t]<<24>>>0}function o(e,t){return String.fromCharCode(e[t++])+String.fromCharCode(e[t++])+String.fromCharCode(e[t++])+String.fromCharCode(e[t])}function a(t){var n=null,r=void 0,i=void 0,o=e(t);if(!o)return n;var s=o.getBox("ftyp"),a=o.getBox("moov");return c.debug("Searching for initialization."),a&&a.isComplete&&(r=s?s.offset:a.offset,i=a.offset+a.size-1,n=r+"-"+i,c.debug("Found the initialization.  Range: "+n)),n}var c=void 0,l=void 0,f=this.context;return l={parse:e,findLastTopIsoBoxCompleted:t,getMediaTimescaleFromMoov:r,getSamplesInfo:n,findInitRange:a},function(){c=(0,s.default)(f).getInstance().getLogger(l)}(),l}Object.defineProperty(t,"__esModule",{value:!0});var o=n(42),s=r(o),a=n(45),u=r(a),c=n(2),l=r(c),f=n(47),d=r(f),h=n(48),p=r(h);i.__dashjs_factory_name="BoxParser",t.default=l.default.getSingletonFactory(i),e.exports=t.default},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(e){function t(e){return e&&e.bind?e.bind(window.console):window.console.log.bind(window.console)}function n(e){return{fatal:o.bind(e),error:a.bind(e),warn:c.bind(e),info:l.bind(e),debug:g.bind(e)}}function r(e){T=e}function i(e){C=e}function o(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];y.apply(void 0,[f,this].concat(t))}function a(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];y.apply(void 0,[d,this].concat(t))}function c(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];y.apply(void 0,[h,this].concat(t))}function l(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];y.apply(void 0,[p,this].concat(t))}function g(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];y.apply(void 0,[_,this].concat(t))}function y(e,t){var n="",r=null;T&&(r=(new Date).getTime(),n+="["+(r-P)+"]"),C&&t&&t.getClassName&&(n+="["+t.getClassName()+"]",t.getType&&(n+="["+t.getType()+"]")),n.length>0&&(n+=" ");for(var i=arguments.length,o=Array(i>2?i-2:0),s=2;s<i;s++)o[s-2]=arguments[s];Array.apply(null,o).forEach(function(e){n+=e+" "}),E[e]&&b.get().debug.logLevel>=e&&E[e](n),m.trigger(u.default.LOG,{message:n,level:e})}e=e||{};var v=this.context,m=(0,s.default)(v).getInstance(),b=e.settings,E=[],w=void 0,T=void 0,C=void 0,P=void 0;return w={getLogger:n,setLogTimestampVisible:r,setCalleeNameVisible:i},function(){T=!0,C=!0,P=(new Date).getTime(),"undefined"!=typeof window&&window.console&&(E[f]=t(window.console.error),E[d]=t(window.console.error),E[h]=t(window.console.warn),E[p]=t(window.console.info),E[_]=t(window.console.debug))}(),w}Object.defineProperty(t,"__esModule",{value:!0});var o=n(12),s=r(o),a=n(13),u=r(a),c=n(2),l=r(c),f=1,d=2,h=3,p=4,_=5;i.__dashjs_factory_name="Debug";var g=l.default.getSingletonFactory(i);g.LOG_LEVEL_NONE=0,g.LOG_LEVEL_FATAL=f,g.LOG_LEVEL_ERROR=d,g.LOG_LEVEL_WARNING=h,g.LOG_LEVEL_INFO=p,g.LOG_LEVEL_DEBUG=_,l.default.updateSingletonFactory(i.__dashjs_factory_name,g),t.default=g,e.exports=t.default},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(t,"__esModule",{value:!0});var s=n(44),a=function(e){return e&&e.__esModule?e:{default:e}}(s),u=function(e){function t(){r(this,t);var e=i(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.BUFFERING_COMPLETED="bufferingCompleted",e.BUFFER_CLEARED="bufferCleared",e.BUFFER_LEVEL_UPDATED="bufferLevelUpdated",e.BYTES_APPENDED="bytesAppended",e.BYTES_APPENDED_END_FRAGMENT="bytesAppendedEndFragment",e.CHECK_FOR_EXISTENCE_COMPLETED="checkForExistenceCompleted",e.CURRENT_TRACK_CHANGED="currentTrackChanged",e.DATA_UPDATE_COMPLETED="dataUpdateCompleted",e.DATA_UPDATE_STARTED="dataUpdateStarted",e.INITIALIZATION_LOADED="initializationLoaded",e.INIT_FRAGMENT_LOADED="initFragmentLoaded",e.INIT_REQUESTED="initRequested",e.INTERNAL_MANIFEST_LOADED="internalManifestLoaded",e.LIVE_EDGE_SEARCH_COMPLETED="liveEdgeSearchCompleted",e.LOADING_COMPLETED="loadingCompleted",e.LOADING_PROGRESS="loadingProgress",e.LOADING_DATA_PROGRESS="loadingDataProgress",e.LOADING_ABANDONED="loadingAborted",e.MANIFEST_UPDATED="manifestUpdated",e.MEDIA_FRAGMENT_LOADED="mediaFragmentLoaded",e.QUOTA_EXCEEDED="quotaExceeded",e.REPRESENTATION_UPDATE_STARTED="representationUpdateStarted",e.REPRESENTATION_UPDATE_COMPLETED="representationUpdateCompleted",e.SEGMENTS_LOADED="segmentsLoaded",e.SERVICE_LOCATION_BLACKLIST_ADD="serviceLocationBlacklistAdd",e.SERVICE_LOCATION_BLACKLIST_CHANGED="serviceLocationBlacklistChanged",e.SOURCEBUFFER_REMOVE_COMPLETED="sourceBufferRemoveCompleted",e.STREAMS_COMPOSED="streamsComposed",e.STREAM_BUFFERING_COMPLETED="streamBufferingCompleted",e.STREAM_COMPLETED="streamCompleted",e.TEXT_TRACKS_QUEUE_INITIALIZED="textTracksQueueInitialized",e.TIMED_TEXT_REQUESTED="timedTextRequested",e.TIME_SYNCHRONIZATION_COMPLETED="timeSynchronizationComplete",e.URL_RESOLUTION_FAILED="urlResolutionFailed",e.VIDEO_CHUNK_RECEIVED="videoChunkReceived",e.WALLCLOCK_TIME_UPDATED="wallclockTimeUpdated",e.XLINK_ELEMENT_LOADED="xlinkElementLoaded",e.XLINK_READY="xlinkReady",e}return o(t,e),t}(a.default);t.default=u,e.exports=t.default},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(){r(this,e)}return i(e,[{key:"extend",value:function(e,t){if(e){var n=!!t&&t.override,r=!!t&&t.publicOnly;for(var i in e)!e.hasOwnProperty(i)||this[i]&&!n||r&&-1===e[i].indexOf("public_")||(this[i]=e[i])}}}]),e}();t.default=o,e.exports=t.default},function(e,t,n){"use strict";function r(e){return e&&e.__esModule?e:{default:e}}function i(){function e(e){return e&&o&&o.boxes&&0!==o.boxes.length&&"function"==typeof o.fetch?i(o.fetch(e)):null}function t(e){var t=[];if(!e||!o||"function"!=typeof o.fetchAll)return t;for(var n=o.fetchAll(e),r=void 0,s=0,a=n.length;s<a;s++)(r=i(n[s]))&&t.push(r);return t}function n(e){o=e}function r(){if(!o||!o.boxes||!o.boxes.length)return null;var e=o.boxes[o.boxes.length-1].type,n=t(e);return n.length>0?n[n.length-1]:null}function i(e){if(!e)return null;var t=new s.default(e);return e.hasOwnProperty("_incomplete")&&(t.isComplete=!e._incomplete),t}var o=void 0;return{getBox:e,getBoxes:t,setData:n,getLastBox:r}}Object.defineProperty(t,"__esModule",{value:!0});var o=n(46),s=r(o),a=n(2),u=r(a);i.__dashjs_factory_name="IsoFile",t.default=u.default.getClassFactory(i),e.exports=t.default},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),o=function(){function e(t){if(r(this,e),this.offset=t._offset,this.type=t.type,this.size=t.size,this.boxes=[],t.boxes)for(var n=0;n<t.boxes.length;n++)this.boxes.push(new e(t.boxes[n]));switch(this.isComplete=!0,t.type){case"sidx":if(this.timescale=t.timescale,this.earliest_presentation_time=t.earliest_presentation_time,this.first_offset=t.first_offset,this.references=t.references,t.references){this.references=[];for(var i=0;i<t.references.length;i++){var o={reference_type:t.references[i].reference_type,referenced_size:t.references[i].referenced_size,subsegment_duration:t.references[i].subsegment_duration};this.references.push(o)}}break;case"emsg":this.id=t.id,this.value=t.value,this.timescale=t.timescale,this.scheme_id_uri=t.scheme_id_uri,this.presentation_time_delta=1===t.version?t.presentation_time:t.presentation_time_delta,this.event_duration=t.event_duration,this.message_data=t.message_data;break;case"mdhd":this.timescale=t.timescale;break;case"mfhd":this.sequence_number=t.sequence_number;break;case"subs":this.entry_count=t.entry_count,this.entries=t.entries;break;case"tfhd":this.base_data_offset=t.base_data_offset,this.sample_description_index=t.sample_description_index,this.default_sample_duration=t.default_sample_duration,this.default_sample_size=t.default_sample_size,this.default_sample_flags=t.default_sample_flags,this.flags=t.flags;break;case"tfdt":this.version=t.version,this.baseMediaDecodeTime=t.baseMediaDecodeTime,this.flags=t.flags;break;case"trun":if(this.sample_count=t.sample_count,this.first_sample_flags=t.first_sample_flags,this.data_offset=t.data_offset,this.flags=t.flags,this.samples=t.samples,t.samples){this.samples=[];for(var s=0,a=t.samples.length;s<a;s++){var u={sample_size:t.samples[s].sample_size,sample_duration:t.samples[s].sample_duration,sample_composition_time_offset:t.samples[s].sample_composition_time_offset};this.samples.push(u)}}}}return i(e,[{key:"getChildBox",value:function(e){for(var t=0;t<this.boxes.length;t++)if(this.boxes[t].type===e)return this.boxes[t]}},{key:"getChildBoxes",value:function(e){for(var t=[],n=0;n<this.boxes.length;n++)this.boxes[n].type===e&&t.push(this.boxes[n]);return t}}]),e}();t.default=o,e.exports=t.default},function(e,t,n){"use strict";var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i={};i.parseBuffer=function(e){return new o(e).parse()},i.addBoxProcessor=function(e,t){"string"==typeof e&&"function"==typeof t&&(s.prototype._boxProcessors[e]=t)},i.createFile=function(){return new o},i.createBox=function(e,t,n){var r=s.create(e);return t&&t.append(r,n),r},i.createFullBox=function(e,t,n){var r=i.createBox(e,t,n);return r.version=0,r.flags=0,r},i.Utils={},i.Utils.dataViewToString=function(e,t){var n=t||"utf-8";if("undefined"!=typeof TextDecoder)return new TextDecoder(n).decode(e);var r=[],i=0;if("utf-8"===n)for(;i<e.byteLength;){var o=e.getUint8(i++);o<128||(o<224?(o=(31&o)<<6,o|=63&e.getUint8(i++)):o<240?(o=(15&o)<<12,o|=(63&e.getUint8(i++))<<6,o|=63&e.getUint8(i++)):(o=(7&o)<<18,o|=(63&e.getUint8(i++))<<12,o|=(63&e.getUint8(i++))<<6,o|=63&e.getUint8(i++))),r.push(String.fromCharCode(o))}else for(;i<e.byteLength;)r.push(String.fromCharCode(e.getUint8(i++)));return r.join("")},i.Utils.utf8ToByteArray=function(e){var t,n;if("undefined"!=typeof TextEncoder)t=(new TextEncoder).encode(e);else for(t=[],n=0;n<e.length;++n){var r=e.charCodeAt(n);r<128?t.push(r):r<2048?(t.push(192|r>>6),t.push(128|63&r)):r<65536?(t.push(224|r>>12),t.push(128|63&r>>6),t.push(128|63&r)):(t.push(240|r>>18),t.push(128|63&r>>12),t.push(128|63&r>>6),t.push(128|63&r))}return t},i.Utils.appendBox=function(e,t,n){if(t._offset=e._cursor.offset,t._root=e._root?e._root:e,t._raw=e._raw,t._parent=e,-1!==n){if(void 0===n||null===n)return void e.boxes.push(t);var i,o=-1;if("number"==typeof n)o=n;else{if("string"==typeof n)i=n;else{if("object"!==(void 0===n?"undefined":r(n))||!n.type)return void e.boxes.push(t);i=n.type}for(var s=0;s<e.boxes.length;s++)if(i===e.boxes[s].type){o=s+1;break}}e.boxes.splice(o,0,t)}},t.parseBuffer=i.parseBuffer,t.addBoxProcessor=i.addBoxProcessor,t.createFile=i.createFile,t.createBox=i.createBox,t.createFullBox=i.createFullBox,t.Utils=i.Utils,i.Cursor=function(e){this.offset=void 0===e?0:e};var o=function(e){this._cursor=new i.Cursor,this.boxes=[],e&&(this._raw=new DataView(e))};o.prototype.fetch=function(e){var t=this.fetchAll(e,!0);return t.length?t[0]:null},o.prototype.fetchAll=function(e,t){var n=[];return o._sweep.call(this,e,n,t),n},o.prototype.parse=function(){for(this._cursor.offset=0,this.boxes=[];this._cursor.offset<this._raw.byteLength;){var e=s.parse(this);if(void 0===e.type)break;this.boxes.push(e)}return this},o._sweep=function(e,t,n){this.type&&this.type==e&&t.push(this);for(var r in this.boxes){if(t.length&&n)return;o._sweep.call(this.boxes[r],e,t,n)}},o.prototype.write=function(){var e,t=0;for(e=0;e<this.boxes.length;e++)t+=this.boxes[e].getLength(!1);var n=new Uint8Array(t);for(this._rawo=new DataView(n.buffer),this.bytes=n,this._cursor.offset=0,e=0;e<this.boxes.length;e++)this.boxes[e].write();return n.buffer},o.prototype.append=function(e,t){i.Utils.appendBox(this,e,t)};var s=function(){this._cursor=new i.Cursor};s.parse=function(e){var t=new s;return t._offset=e._cursor.offset,t._root=e._root?e._root:e,t._raw=e._raw,t._parent=e,t._parseBox(),e._cursor.offset=t._raw.byteOffset+t._raw.byteLength,t},s.create=function(e){var t=new s;return t.type=e,t.boxes=[],t},s.prototype._boxContainers=["dinf","edts","mdia","meco","mfra","minf","moof","moov","mvex","stbl","strk","traf","trak","tref","udta","vttc","sinf","schi","encv","enca"],s.prototype._boxProcessors={},s.prototype._procField=function(e,t,n){this._parsing?this[e]=this._readField(t,n):this._writeField(t,n,this[e])},s.prototype._procFieldArray=function(e,t,n,r){var i;if(this._parsing)for(this[e]=[],i=0;i<t;i++)this[e][i]=this._readField(n,r);else for(i=0;i<this[e].length;i++)this._writeField(n,r,this[e][i])},s.prototype._procFullBox=function(){this._procField("version","uint",8),this._procField("flags","uint",24)},s.prototype._procEntries=function(e,t,n){var r;if(this._parsing)for(this[e]=[],r=0;r<t;r++)this[e].push({}),n.call(this,this[e][r]);else for(r=0;r<t;r++)n.call(this,this[e][r])},s.prototype._procSubEntries=function(e,t,n,r){var i;if(this._parsing)for(e[t]=[],i=0;i<n;i++)e[t].push({}),r.call(this,e[t][i]);else for(i=0;i<n;i++)r.call(this,e[t][i])},s.prototype._procEntryField=function(e,t,n,r){this._parsing?e[t]=this._readField(n,r):this._writeField(n,r,e[t])},s.prototype._procSubBoxes=function(e,t){var n;if(this._parsing)for(this[e]=[],n=0;n<t;n++)this[e].push(s.parse(this));else for(n=0;n<t;n++)this._rawo?this[e][n].write():this.size+=this[e][n].getLength()},s.prototype._readField=function(e,t){switch(e){case"uint":return this._readUint(t);case"int":return this._readInt(t);case"template":return this._readTemplate(t);case"string":return-1===t?this._readTerminatedString():this._readString(t);case"data":return this._readData(t);case"utf8":return this._readUTF8String();default:return-1}},s.prototype._readInt=function(e){var t=null,n=this._cursor.offset-this._raw.byteOffset;switch(e){case 8:t=this._raw.getInt8(n);break;case 16:t=this._raw.getInt16(n);break;case 32:t=this._raw.getInt32(n);break;case 64:var r=this._raw.getInt32(n),i=this._raw.getInt32(n+4);t=r*Math.pow(2,32)+i}return this._cursor.offset+=e>>3,t},s.prototype._readUint=function(e){var t,n,r=null,i=this._cursor.offset-this._raw.byteOffset;switch(e){case 8:r=this._raw.getUint8(i);break;case 16:r=this._raw.getUint16(i);break;case 24:t=this._raw.getUint16(i),n=this._raw.getUint8(i+2),r=(t<<8)+n;break;case 32:r=this._raw.getUint32(i);break;case 64:t=this._raw.getUint32(i),n=this._raw.getUint32(i+4),r=t*Math.pow(2,32)+n}return this._cursor.offset+=e>>3,r},s.prototype._readString=function(e){for(var t="",n=0;n<e;n++){var r=this._readUint(8);t+=String.fromCharCode(r)}return t},s.prototype._readTemplate=function(e){return this._readUint(e/2)+this._readUint(e/2)/Math.pow(2,e/2)},s.prototype._readTerminatedString=function(){for(var e="";this._cursor.offset-this._offset<this._raw.byteLength;){var t=this._readUint(8);if(0===t)break;e+=String.fromCharCode(t)}return e},s.prototype._readData=function(e){var t=e>0?e:this._raw.byteLength-(this._cursor.offset-this._offset);if(t>0){var n=new Uint8Array(this._raw.buffer,this._cursor.offset,t);return this._cursor.offset+=t,n}return null},s.prototype._readUTF8String=function(){var e=this._raw.byteLength-(this._cursor.offset-this._offset),t=null;return e>0&&(t=new DataView(this._raw.buffer,this._cursor.offset,e),this._cursor.offset+=e),t?i.Utils.dataViewToString(t):t},s.prototype._parseBox=function(){if(this._parsing=!0,this._cursor.offset=this._offset,this._offset+8>this._raw.buffer.byteLength)return void(this._root._incomplete=!0);switch(this._procField("size","uint",32),this._procField("type","string",4),1===this.size&&this._procField("largesize","uint",64),"uuid"===this.type&&this._procFieldArray("usertype",16,"uint",8),this.size){case 0:this._raw=new DataView(this._raw.buffer,this._offset,this._raw.byteLength-this._cursor.offset+8);break;case 1:this._offset+this.size>this._raw.buffer.byteLength?(this._incomplete=!0,this._root._incomplete=!0):this._raw=new DataView(this._raw.buffer,this._offset,this.largesize);break;default:this._offset+this.size>this._raw.buffer.byteLength?(this._incomplete=!0,this._root._incomplete=!0):this._raw=new DataView(this._raw.buffer,this._offset,this.size)}this._incomplete||(this._boxProcessors[this.type]&&this._boxProcessors[this.type].call(this),-1!==this._boxContainers.indexOf(this.type)?this._parseContainerBox():this._data=this._readData())},s.prototype._parseFullBox=function(){this.version=this._readUint(8),this.flags=this._readUint(24)},s.prototype._parseContainerBox=function(){for(this.boxes=[];this._cursor.offset-this._raw.byteOffset<this._raw.byteLength;)this.boxes.push(s.parse(this))},s.prototype.append=function(e,t){i.Utils.appendBox(this,e,t)},s.prototype.getLength=function(){if(this._parsing=!1,this._rawo=null,this.size=0,this._procField("size","uint",32),this._procField("type","string",4),1===this.size&&this._procField("largesize","uint",64),"uuid"===this.type&&this._procFieldArray("usertype",16,"uint",8),this._boxProcessors[this.type]&&this._boxProcessors[this.type].call(this),-1!==this._boxContainers.indexOf(this.type))for(var e=0;e<this.boxes.length;e++)this.size+=this.boxes[e].getLength();return this._data&&this._writeData(this._data),this.size},s.prototype.write=function(){switch(this._parsing=!1,this._cursor.offset=this._parent._cursor.offset,this.size){case 0:this._rawo=new DataView(this._parent._rawo.buffer,this._cursor.offset,this.parent._rawo.byteLength-this._cursor.offset);break;case 1:this._rawo=new DataView(this._parent._rawo.buffer,this._cursor.offset,this.largesize);break;default:this._rawo=new DataView(this._parent._rawo.buffer,this._cursor.offset,this.size)}if(this._procField("size","uint",32),this._procField("type","string",4),1===this.size&&this._procField("largesize","uint",64),"uuid"===this.type&&this._procFieldArray("usertype",16,"uint",8),this._boxProcessors[this.type]&&this._boxProcessors[this.type].call(this),-1!==this._boxContainers.indexOf(this.type))for(var e=0;e<this.boxes.length;e++)this.boxes[e].write();return this._data&&this._writeData(this._data),this._parent._cursor.offset+=this.size,this.size},s.prototype._writeInt=function(e,t){if(this._rawo){var n=this._cursor.offset-this._rawo.byteOffset;switch(e){case 8:this._rawo.setInt8(n,t);break;case 16:this._rawo.setInt16(n,t);break;case 32:this._rawo.setInt32(n,t);break;case 64:var r=Math.floor(t/Math.pow(2,32)),i=t-r*Math.pow(2,32);this._rawo.setUint32(n,r),this._rawo.setUint32(n+4,i)}this._cursor.offset+=e>>3}else this.size+=e>>3},s.prototype._writeUint=function(e,t){if(this._rawo){var n,r,i=this._cursor.offset-this._rawo.byteOffset;switch(e){case 8:this._rawo.setUint8(i,t);break;case 16:this._rawo.setUint16(i,t);break;case 24:n=(16776960&t)>>8,r=255&t,this._rawo.setUint16(i,n),this._rawo.setUint8(i+2,r);break;case 32:this._rawo.setUint32(i,t);break;case 64:n=Math.floor(t/Math.pow(2,32)),r=t-n*Math.pow(2,32),this._rawo.setUint32(i,n),this._rawo.setUint32(i+4,r)}this._cursor.offset+=e>>3}else this.size+=e>>3},s.prototype._writeString=function(e,t){for(var n=0;n<e;n++)this._writeUint(8,t.charCodeAt(n))},s.prototype._writeTerminatedString=function(e){if(0!==e.length){for(var t=0;t<e.length;t++)this._writeUint(8,e.charCodeAt(t));this._writeUint(8,0)}},s.prototype._writeTemplate=function(e,t){var n=Math.floor(t),r=(t-n)*Math.pow(2,e/2);this._writeUint(e/2,n),this._writeUint(e/2,r)},s.prototype._writeData=function(e){var t;if(e)if(this._rawo){if(e instanceof Array){for(var n=this._cursor.offset-this._rawo.byteOffset,t=0;t<e.length;t++)this._rawo.setInt8(n+t,e[t]);this._cursor.offset+=e.length}e instanceof Uint8Array&&(this._root.bytes.set(e,this._cursor.offset),this._cursor.offset+=e.length)}else this.size+=e.length},s.prototype._writeUTF8String=function(e){var t=i.Utils.utf8ToByteArray(e);if(this._rawo)for(var n=new DataView(this._rawo.buffer,this._cursor.offset,t.length),r=0;r<t.length;r++)n.setUint8(r,t[r]);else this.size+=t.length},s.prototype._writeField=function(e,t,n){switch(e){case"uint":this._writeUint(t,n);break;case"int":this._writeInt(t,n);break;case"template":this._writeTemplate(t,n);break;case"string":-1==t?this._writeTerminatedString(n):this._writeString(t,n);break;case"data":this._writeData(n);break;case"utf8":this._writeUTF8String(n)}},s.prototype._boxProcessors.avc1=s.prototype._boxProcessors.encv=function(){this._procFieldArray("reserved1",6,"uint",8),this._procField("data_reference_index","uint",16),this._procField("pre_defined1","uint",16),this._procField("reserved2","uint",16),this._procFieldArray("pre_defined2",3,"uint",32),this._procField("width","uint",16),this._procField("height","uint",16),this._procField("horizresolution","template",32),this._procField("vertresolution","template",32),this._procField("reserved3","uint",32),this._procField("frame_count","uint",16),this._procFieldArray("compressorname",32,"uint",8),this._procField("depth","uint",16),this._procField("pre_defined3","int",16),this._procField("config","data",-1)},s.prototype._boxProcessors.dref=function(){this._procFullBox(),this._procField("entry_count","uint",32),this._procSubBoxes("entries",this.entry_count)},s.prototype._boxProcessors.elst=function(){this._procFullBox(),this._procField("entry_count","uint",32),this._procEntries("entries",this.entry_count,function(e){this._procEntryField(e,"segment_duration","uint",1===this.version?64:32),this._procEntryField(e,"media_time","int",1===this.version?64:32),this._procEntryField(e,"media_rate_integer","int",16),this._procEntryField(e,"media_rate_fraction","int",16)})},s.prototype._boxProcessors.emsg=function(){this._procFullBox(),1==this.version?(this._procField("timescale","uint",32),this._procField("presentation_time","uint",64),this._procField("event_duration","uint",32),this._procField("id","uint",32),this._procField("scheme_id_uri","string",-1),this._procField("value","string",-1)):(this._procField("scheme_id_uri","string",-1),this._procField("value","string",-1),this._procField("timescale","uint",32),this._procField("presentation_time_delta","uint",32),this._procField("event_duration","uint",32),this._procField("id","uint",32)),this._procField("message_data","data",-1)},s.prototype._boxProcessors.free=s.prototype._boxProcessors.skip=function(){this._procField("data","data",-1)},s.prototype._boxProcessors.frma=function(){this._procField("data_format","uint",32)},s.prototype._boxProcessors.ftyp=s.prototype._boxProcessors.styp=function(){this._procField("major_brand","string",4),this._procField("minor_version","uint",32);var e=-1;this._parsing&&(e=(this._raw.byteLength-(this._cursor.offset-this._raw.byteOffset))/4),this._procFieldArray("compatible_brands",e,"string",4)},s.prototype._boxProcessors.hdlr=function(){this._procFullBox(),this._procField("pre_defined","uint",32),this._procField("handler_type","string",4),this._procFieldArray("reserved",3,"uint",32),this._procField("name","string",-1)},s.prototype._boxProcessors.mdat=function(){this._procField("data","data",-1)},s.prototype._boxProcessors.mdhd=function(){this._procFullBox(),this._procField("creation_time","uint",1==this.version?64:32),this._procField("modification_time","uint",1==this.version?64:32),this._procField("timescale","uint",32),this._procField("duration","uint",1==this.version?64:32),this._parsing||"string"!=typeof this.language||(this.language=this.language.charCodeAt(0)-96<<10|this.language.charCodeAt(1)-96<<5|this.language.charCodeAt(2)-96),this._procField("language","uint",16),this._parsing&&(this.language=String.fromCharCode(96+(this.language>>10&31),96+(this.language>>5&31),96+(31&this.language))),this._procField("pre_defined","uint",16)},s.prototype._boxProcessors.mehd=function(){this._procFullBox(),this._procField("fragment_duration","uint",1==this.version?64:32)},s.prototype._boxProcessors.mfhd=function(){this._procFullBox(),this._procField("sequence_number","uint",32)},s.prototype._boxProcessors.mfro=function(){this._procFullBox(),this._procField("mfra_size","uint",32)},s.prototype._boxProcessors.mp4a=s.prototype._boxProcessors.enca=function(){this._procFieldArray("reserved1",6,"uint",8),this._procField("data_reference_index","uint",16),this._procFieldArray("reserved2",2,"uint",32),this._procField("channelcount","uint",16),this._procField("samplesize","uint",16),this._procField("pre_defined","uint",16),this._procField("reserved3","uint",16),this._procField("samplerate","template",32),this._procField("esds","data",-1)},s.prototype._boxProcessors.mvhd=function(){this._procFullBox(),this._procField("creation_time","uint",1==this.version?64:32),this._procField("modification_time","uint",1==this.version?64:32),this._procField("timescale","uint",32),this._procField("duration","uint",1==this.version?64:32),this._procField("rate","template",32),this._procField("volume","template",16),this._procField("reserved1","uint",16),this._procFieldArray("reserved2",2,"uint",32),this._procFieldArray("matrix",9,"template",32),this._procFieldArray("pre_defined",6,"uint",32),this._procField("next_track_ID","uint",32)},s.prototype._boxProcessors.payl=function(){this._procField("cue_text","utf8")},s.prototype._boxProcessors.pssh=function(){this._procFullBox(),this._procFieldArray("SystemID",16,"uint",8),this._procField("DataSize","uint",32),this._procFieldArray("Data",this.DataSize,"uint",8)},s.prototype._boxProcessors.schm=function(){this._procFullBox(),this._procField("scheme_type","uint",32),this._procField("scheme_version","uint",32),1&this.flags&&this._procField("scheme_uri","string",-1)},s.prototype._boxProcessors.sdtp=function(){this._procFullBox();var e=-1;this._parsing&&(e=this._raw.byteLength-(this._cursor.offset-this._raw.byteOffset)),this._procFieldArray("sample_dependency_table",e,"uint",8)},s.prototype._boxProcessors.sidx=function(){this._procFullBox(),this._procField("reference_ID","uint",32),this._procField("timescale","uint",32),this._procField("earliest_presentation_time","uint",1==this.version?64:32),this._procField("first_offset","uint",1==this.version?64:32),this._procField("reserved","uint",16),this._procField("reference_count","uint",16),this._procEntries("references",this.reference_count,function(e){this._parsing||(e.reference=(1&e.reference_type)<<31,e.reference|=2147483647&e.referenced_size,e.sap=(1&e.starts_with_SAP)<<31,e.sap|=(3&e.SAP_type)<<28,e.sap|=268435455&e.SAP_delta_time),this._procEntryField(e,"reference","uint",32),this._procEntryField(e,"subsegment_duration","uint",32),this._procEntryField(e,"sap","uint",32),this._parsing&&(e.reference_type=e.reference>>31&1,e.referenced_size=2147483647&e.reference,e.starts_with_SAP=e.sap>>31&1,e.SAP_type=e.sap>>28&7,e.SAP_delta_time=268435455&e.sap)})},s.prototype._boxProcessors.smhd=function(){this._procFullBox(),this._procField("balance","uint",16),this._procField("reserved","uint",16)},s.prototype._boxProcessors.ssix=function(){this._procFullBox(),this._procField("subsegment_count","uint",32),this._procEntries("subsegments",this.subsegment_count,function(e){this._procEntryField(e,"ranges_count","uint",32),this._procSubEntries(e,"ranges",e.ranges_count,function(e){this._procEntryField(e,"level","uint",8),this._procEntryField(e,"range_size","uint",24)})})},s.prototype._boxProcessors.stsd=function(){this._procFullBox(),this._procField("entry_count","uint",32),this._procSubBoxes("entries",this.entry_count)},s.prototype._boxProcessors.subs=function(){this._procFullBox(),this._procField("entry_count","uint",32),this._procEntries("entries",this.entry_count,function(e){this._procEntryField(e,"sample_delta","uint",32),this._procEntryField(e,"subsample_count","uint",16),this._procSubEntries(e,"subsamples",e.subsample_count,function(e){this._procEntryField(e,"subsample_size","uint",1===this.version?32:16),this._procEntryField(e,"subsample_priority","uint",8),this._procEntryField(e,"discardable","uint",8),this._procEntryField(e,"codec_specific_parameters","uint",32)})})},s.prototype._boxProcessors.tenc=function(){this._procFullBox(),this._procField("default_IsEncrypted","uint",24),this._procField("default_IV_size","uint",8),this._procFieldArray("default_KID",16,"uint",8)},s.prototype._boxProcessors.tfdt=function(){this._procFullBox(),this._procField("baseMediaDecodeTime","uint",1==this.version?64:32)},s.prototype._boxProcessors.tfhd=function(){this._procFullBox(),this._procField("track_ID","uint",32),1&this.flags&&this._procField("base_data_offset","uint",64),2&this.flags&&this._procField("sample_description_offset","uint",32),8&this.flags&&this._procField("default_sample_duration","uint",32),16&this.flags&&this._procField("default_sample_size","uint",32),32&this.flags&&this._procField("default_sample_flags","uint",32)},s.prototype._boxProcessors.tfra=function(){this._procFullBox(),this._procField("track_ID","uint",32),this._parsing||(this.reserved=0,this.reserved|=(48&this.length_size_of_traf_num)<<4,this.reserved|=(12&this.length_size_of_trun_num)<<2,this.reserved|=3&this.length_size_of_sample_num),this._procField("reserved","uint",32),this._parsing&&(this.length_size_of_traf_num=(48&this.reserved)>>4,this.length_size_of_trun_num=(12&this.reserved)>>2,this.length_size_of_sample_num=3&this.reserved),this._procField("number_of_entry","uint",32),this._procEntries("entries",this.number_of_entry,function(e){this._procEntryField(e,"time","uint",1===this.version?64:32),this._procEntryField(e,"moof_offset","uint",1===this.version?64:32),this._procEntryField(e,"traf_number","uint",8*(this.length_size_of_traf_num+1)),this._procEntryField(e,"trun_number","uint",8*(this.length_size_of_trun_num+1)),this._procEntryField(e,"sample_number","uint",8*(this.length_size_of_sample_num+1))})},s.prototype._boxProcessors.tkhd=function(){this._procFullBox(),this._procField("creation_time","uint",1==this.version?64:32),this._procField("modification_time","uint",1==this.version?64:32),this._procField("track_ID","uint",32),this._procField("reserved1","uint",32),this._procField("duration","uint",1==this.version?64:32),this._procFieldArray("reserved2",2,"uint",32),this._procField("layer","uint",16),this._procField("alternate_group","uint",16),this._procField("volume","template",16),this._procField("reserved3","uint",16),this._procFieldArray("matrix",9,"template",32),this._procField("width","template",32),this._procField("height","template",32)},s.prototype._boxProcessors.trex=function(){this._procFullBox(),this._procField("track_ID","uint",32),this._procField("default_sample_description_index","uint",32),this._procField("default_sample_duration","uint",32),this._procField("default_sample_size","uint",32),this._procField("default_sample_flags","uint",32)},s.prototype._boxProcessors.trun=function(){this._procFullBox(),this._procField("sample_count","uint",32),1&this.flags&&this._procField("data_offset","int",32),4&this.flags&&this._procField("first_sample_flags","uint",32),this._procEntries("samples",this.sample_count,function(e){256&this.flags&&this._procEntryField(e,"sample_duration","uint",32),512&this.flags&&this._procEntryField(e,"sample_size","uint",32),1024&this.flags&&this._procEntryField(e,"sample_flags","uint",32),2048&this.flags&&this._procEntryField(e,"sample_composition_time_offset",1===this.version?"int":"uint",32)})},s.prototype._boxProcessors["url "]=s.prototype._boxProcessors["urn "]=function(){this._procFullBox(),"urn "===this.type&&this._procField("name","string",-1),this._procField("location","string",-1)},s.prototype._boxProcessors.vlab=function(){this._procField("source_label","utf8")},s.prototype._boxProcessors.vmhd=function(){this._procFullBox(),this._procField("graphicsmode","uint",16),this._procFieldArray("opcolor",3,"uint",16)},s.prototype._boxProcessors.vttC=function(){this._procField("config","utf8")},s.prototype._boxProcessors.vtte=function(){}},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(t,"__esModule",{value:!0});var i=function e(t,n,i){r(this,e),this.lastCompletedOffset=t,this.found=n,this.size=i};t.default=i,e.exports=t.default}])});